syntax = "proto3";

package pb;
option go_package = "lazervaultGolang/pb";

import "google/api/annotations.proto";
import "protoc-gen-openapiv2/options/annotations.proto";
import "google/protobuf/timestamp.proto";

option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = {
    info: {
        title: "LazerVault API";
        version: "1.0";
        description: "LazerVault Transfer API";
    };
    schemes: HTTP;
    schemes: HTTPS;
    consumes: "application/json";
    produces: "application/json";
    security_definitions: {
        security: {
            key: "bearer";
            value: {
                type: TYPE_API_KEY;
                in: IN_HEADER;
                name: "Authorization";
                description: "Authentication token, prefixed by Bearer: Bearer <token>";
            };
        };
    };
    security: {
        security_requirement: {
            key: "bearer";
        };
    };
};

// Transfer Type Enum
enum TransferType {
  TRANSFER_TYPE_UNSPECIFIED = 0;
  TRANSFER_TYPE_INCOME = 1;      // Incoming transfer (e.g., deposit, received payment)
  TRANSFER_TYPE_EXPENSE = 2;     // Outgoing transfer (e.g., payment, withdrawal)
  TRANSFER_TYPE_INTERNAL = 3;    // Transfer between user's own accounts
}

// Main Transfer Transaction message
message TransferTransaction {
  string transaction_id = 1;          // Unique ID for the transfer
  uint64 from_account_id = 2;         // Source LazerVault account ID
  uint64 to_account_id = 3;           // Destination LazerVault account ID (if internal)
  string to_recipient_id = 4;         // Destination Recipient ID (if external)
  double amount = 5;                  // Amount transferred
  string currency = 6;                // Currency code (e.g., "GBP")
  TransferType transfer_type = 7;     // Type of transfer (Income/Expense/Internal)
  string category = 8;                // User-defined or system-assigned category (e.g., "Shopping", "Salary")
  string description = 9;             // Optional description/note for the transfer
  google.protobuf.Timestamp created_at = 10;
}

// Request message for initiating a transfer
message InitiateTransferRequest {
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
      json_schema: {
        required: ["from_account_id", "amount"];
      };
    };
    uint64 from_account_id = 1 [json_name = "from_account_id"]; // Required
    uint64 amount = 2;          // Required, minor units (e.g., cents, pence)
    string category = 3;
    string reference = 4;
    optional string scheduled_at = 5; // Optional. If not provided, processed immediately. Format: "2006-01-02T15:04:05Z07:00"

    // --- Destination (Use ONE of the following) ---
    uint64 to_account_id = 10 [json_name = "to_account_id"]; // Optional: Direct internal account ID
    uint64 recipient_id = 11 [json_name = "recipient_id"];   // Optional: ID of the saved recipient (internal or external)

    // --- Removed Direct External Details ---
    // ... (removed fields remain removed)
}

// Response message for initiating a transfer
message InitiateTransferResponse {
    uint64 transfer_id = 1;
    string status = 2;
    uint64 amount = 3;          // Changed to uint64 (minor units)
    uint64 fee = 4;             // Changed to uint64 (minor units)
    uint64 total_amount = 5;    // Changed to uint64 (minor units)
    google.protobuf.Timestamp created_at = 6;
}

// Time Period Enum for Statistics
enum TimePeriod {
  TIME_PERIOD_UNSPECIFIED = 0;
  TIME_PERIOD_WEEK = 1;
  TIME_PERIOD_MONTH = 2;
  TIME_PERIOD_QUARTER = 3;
  TIME_PERIOD_YEAR = 4;
  TIME_PERIOD_ALL = 5; // Or use start/end dates
}

// Represents a single point in a time series chart
message TimeSeriesPoint {
  google.protobuf.Timestamp timestamp = 1;
  double amount = 2;
}

// Represents summary data for a specific category
message CategorySummary {
  string category = 1;
  // string subcategory = 2; // Optional: Add if subcategory breakdown is needed
  double amount = 3;
  double percentage = 4; // Percentage of total income/expense for the period
}

// Represents aggregated data for a single month
message MonthlyData {
  string month = 1; // e.g., "Jan", "Feb" or "YYYY-MM"
  double income = 2;
  double expenses = 3;
}

// Represents data for month-over-month comparison
message ComparisonData {
  double current_income = 1;
  double previous_income = 2;
  double current_expenses = 3;
  double previous_expenses = 4;
  double current_savings = 5; // Calculated: current_income - current_expenses
  double previous_savings = 6; // Calculated: previous_income - previous_expenses
}

// Request message for fetching statistics
message GetStatisticsRequest {
   option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      required: ["time_period"];
    };
  };
  TimePeriod time_period = 1;
  // google.protobuf.Timestamp start_date = 2; // Alternative to TimePeriod
  // google.protobuf.Timestamp end_date = 3;   // Alternative to TimePeriod
  string currency = 4; // Optional: Filter by currency
}

// Response message containing calculated statistics
message GetStatisticsResponse {
  double total_income = 1;
  double total_expenses = 2;
  repeated TimeSeriesPoint expense_timeseries = 3;     // For expense line chart
  repeated CategorySummary expense_breakdown = 4;    // For expense pie chart/list
  repeated CategorySummary income_breakdown = 5;     // For income pie chart/list
  repeated MonthlyData monthly_overview = 6;        // For monthly bar chart (e.g., last 6 months)
  ComparisonData comparison_metrics = 7;           // For MoM comparison
}

// --- Transaction History ---

// Request message for getting transfer details
message GetTransferDetailsRequest {
    uint64 transfer_id = 1 [json_name = "transfer_id"]; // ID of the transfer to retrieve
}

// Response message containing transfer details
message GetTransferDetailsResponse {
    uint64 transfer_id = 1 [json_name = "transfer_id"];
    uint64 from_account_id = 2 [json_name = "from_account_id"];
    uint64 to_account_id = 3 [json_name = "to_account_id"];
    uint64 from_user_id = 4 [json_name = "from_user_id"]; // Added for context
    uint64 to_user_id = 5 [json_name = "to_user_id"];     // Added for context
    uint64 amount = 6;          // Amount in minor units
    uint64 fee = 7;             // Fee in minor units
    uint64 total_amount = 8;    // Total amount in minor units
    string currency = 9;        // Added currency
    string status = 10;         // Status string (e.g., "pending", "completed")
    string reference = 11;
    string category = 12;
    google.protobuf.Timestamp created_at = 13 [json_name = "created_at"];
    optional string scheduled_at = 14 [json_name = "scheduled_at"]; // Optional, format: "2006-01-02T15:04:05Z07:00"
    google.protobuf.Timestamp completed_at = 15 [json_name = "completed_at"]; // Null if not completed
    google.protobuf.Timestamp failed_at = 16 [json_name = "failed_at"];    // Null if not failed
    string failure_reason = 17 [json_name = "failure_reason"];    // Empty if not failed
}

// Pagination metadata for transfer lists
message TransferPaginationInfo {
  int32 current_page = 1;
  int32 total_pages = 2;
  int32 total_items = 3;
  int32 items_per_page = 4;
  bool has_next = 5;
  bool has_prev = 6;
}

// Request message for listing transfers with pagination
message ListTransfersRequest {
  int32 page = 1;          // Page number (default: 1)
  int32 page_size = 2;     // Items per page (default: 20, max: 100)
  string status = 3;       // Optional filter by status
  string sort_by = 4;      // Sort field (default: "created_at")
  string sort_order = 5;   // "asc" or "desc" (default: "desc")
  string search = 6;       // Optional search query (reference, category)
}

// Response message for listing transfers
message ListTransfersResponse {
  repeated GetTransferDetailsResponse transfers = 1;
  TransferPaginationInfo pagination = 2;
}

// --- Batch Transfer Messages ---

// Represents a single recipient in a batch transfer
message BatchRecipient {
    uint64 recipient_id = 1;        // ID of the saved recipient
    uint64 to_account_id = 2;       // Optional: Direct account ID (if not using recipient_id)
    uint64 amount = 3;              // Amount in minor units (cents/pence)
    string reference = 4;           // Optional reference for this transfer
    string category = 5;            // Optional category for this transfer
}

// Request message for initiating a batch transfer
message InitiateBatchTransferRequest {
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
      json_schema: {
        required: ["from_account_id", "recipients"];
      };
    };
    uint64 from_account_id = 1 [json_name = "from_account_id"]; // Source account
    repeated BatchRecipient recipients = 2;                      // List of recipients
    optional string scheduled_at = 3; // Optional. If not provided, processed immediately
}

// Represents the result of a single transfer within a batch
message BatchTransferResult {
    uint64 transfer_id = 1;         // ID of the individual transfer
    string status = 2;              // "completed" or "failed"
    uint64 amount = 3;              // Amount in minor units
    uint64 fee = 4;                 // Fee in minor units
    string recipient_name = 5;      // Recipient name for display
    string recipient_account = 6;   // Masked account number (e.g., "****1234")
    string failure_reason = 7;      // Empty if successful, reason if failed
}

// Response message for initiating a batch transfer
message InitiateBatchTransferResponse {
    uint64 batch_id = 1;                            // Unique batch ID
    string status = 2;                              // "processing", "completed", "partial_success", "failed"
    uint64 total_amount = 3;                        // Total amount in minor units
    uint64 total_fee = 4;                           // Total fee in minor units
    uint64 total_amount_with_fee = 5;               // Total including fees
    int32 successful_transfers = 6;                 // Number of successful transfers
    int32 failed_transfers = 7;                     // Number of failed transfers
    int32 total_transfers = 8;                      // Total number of transfers
    repeated BatchTransferResult results = 9;        // Individual transfer results
    google.protobuf.Timestamp created_at = 10;
    google.protobuf.Timestamp completed_at = 11;    // Null if still processing
}

// Request message for getting batch transfer status
message GetBatchTransferStatusRequest {
    uint64 batch_id = 1 [json_name = "batch_id"];  // ID of the batch to check
}

// Response message for getting batch transfer status (same as initiate response)
message GetBatchTransferStatusResponse {
    uint64 batch_id = 1;
    string status = 2;
    uint64 total_amount = 3;
    uint64 total_fee = 4;
    uint64 total_amount_with_fee = 5;
    int32 successful_transfers = 6;
    int32 failed_transfers = 7;
    int32 total_transfers = 8;
    repeated BatchTransferResult results = 9;
    google.protobuf.Timestamp created_at = 10;
    google.protobuf.Timestamp completed_at = 11;
}

// Request message for getting batch transfer history
message GetBatchTransferHistoryRequest {
    int32 page = 1;          // Page number (default: 1)
    int32 page_size = 2;     // Items per page (default: 20, max: 100)
    string status = 3;       // Optional filter by status
}

// Response message for getting batch transfer history
message GetBatchTransferHistoryResponse {
    repeated GetBatchTransferStatusResponse batches = 1;
    TransferPaginationInfo pagination = 2;
}

// Service definition for transfers
service TransferService {
    // Initiates a new transfer
    rpc InitiateTransfer(InitiateTransferRequest) returns (InitiateTransferResponse) {
        option (google.api.http) = {
            post: "/v1/transfers";
            body: "*";
        };
        option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
            summary: "Initiate a new transfer";
            description: "Initiates a new transfer with the provided details";
            tags: ["transfers"];
        };
    };

    // Lists all transfers for the authenticated user with pagination
    rpc ListTransfers(ListTransfersRequest) returns (ListTransfersResponse) {
        option (google.api.http) = {
            get: "/v1/transfers";
        };
        option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
            summary: "List Transfers";
            description: "Retrieves a paginated list of transfers for the authenticated user";
            tags: ["Transfers"];
        };
    }

    // Fetches aggregated financial statistics based on transfer history.
    rpc GetStatistics (GetStatisticsRequest) returns (GetStatisticsResponse) {
        option (google.api.http) = {
            get: "/v1/transfers/statistics";
        };
        option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
            summary: "Get Financial Statistics";
            description: "Retrieves aggregated income, expense, and categorized statistics based on transfer history for a given time period.";
            tags: ["Transfers"];
      };
    }

    // Retrieves the details of a specific transfer transaction.
    rpc GetTransferDetails (GetTransferDetailsRequest) returns (GetTransferDetailsResponse) {
        option (google.api.http) = {
            get: "/v1/transfers/{transfer_id}";
        };
        option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
            summary: "Get Transfer Details";
            description: "Retrieves the details of a specific transfer transaction by its ID.";
            tags: ["Transfers"];
        };
    }

    // Initiates a batch transfer to multiple recipients
    rpc InitiateBatchTransfer(InitiateBatchTransferRequest) returns (InitiateBatchTransferResponse) {
        option (google.api.http) = {
            post: "/v1/transfers/batch";
            body: "*";
        };
        option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
            summary: "Initiate a batch transfer";
            description: "Initiates a batch transfer to multiple recipients in a single transaction";
            tags: ["transfers"];
        };
    }

    // Gets the status of a batch transfer
    rpc GetBatchTransferStatus(GetBatchTransferStatusRequest) returns (GetBatchTransferStatusResponse) {
        option (google.api.http) = {
            get: "/v1/transfers/batch/{batch_id}";
        };
        option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
            summary: "Get Batch Transfer Status";
            description: "Retrieves the current status and details of a batch transfer";
            tags: ["Transfers"];
        };
    }

    // Gets the history of batch transfers
    rpc GetBatchTransferHistory(GetBatchTransferHistoryRequest) returns (GetBatchTransferHistoryResponse) {
        option (google.api.http) = {
            get: "/v1/transfers/batch";
        };
        option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
            summary: "Get Batch Transfer History";
            description: "Retrieves a paginated list of batch transfers";
            tags: ["Transfers"];
        };
    }
}