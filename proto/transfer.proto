syntax = "proto3";

package pb;
option go_package = "lazervaultGolang/pb";

import "google/api/annotations.proto";
import "protoc-gen-openapiv2/options/annotations.proto";
import "google/protobuf/timestamp.proto";

option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = {
    info: {
        title: "LazerVault API"
        version: "1.0"
        description: "LazerVault Transfer API"
    }
    schemes: HTTP
    schemes: HTTPS
    consumes: "application/json"
    produces: "application/json"
};

// Transfer Type Enum
enum TransferType {
  TRANSFER_TYPE_UNSPECIFIED = 0;
  TRANSFER_TYPE_INCOME = 1;      // Incoming transfer (e.g., deposit, received payment)
  TRANSFER_TYPE_EXPENSE = 2;     // Outgoing transfer (e.g., payment, withdrawal)
  TRANSFER_TYPE_INTERNAL = 3;    // Transfer between user's own accounts
}

// Main Transfer Transaction message
message TransferTransaction {
  string transaction_id = 1;          // Unique ID for the transfer
  uint64 from_account_id = 2;         // Source LazerVault account ID
  uint64 to_account_id = 3;           // Destination LazerVault account ID (if internal)
  string to_recipient_id = 4;         // Destination Recipient ID (if external)
  double amount = 5;                  // Amount transferred
  string currency = 6;                // Currency code (e.g., "GBP")
  TransferType transfer_type = 7;     // Type of transfer (Income/Expense/Internal)
  string category = 8;                // User-defined or system-assigned category (e.g., "Shopping", "Salary")
  string description = 9;             // Optional description/note for the transfer
  google.protobuf.Timestamp created_at = 10;
}

// Request message for initiating a transfer
message InitiateTransferRequest {
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
      json_schema: {
        // recipient_id OR to_account_id is required - validated in service
        required: ["from_account_id", "amount"]
      }
    };
    uint64 from_account_id = 1 [json_name = "from_account_id"]; // Required
    uint64 amount = 2;          // Required, minor units (e.g., cents, pence)
    string category = 3;
    string reference = 4;
    google.protobuf.Timestamp scheduled_at = 5; // Optional. If not provided, processed immediately.

    // --- Destination (Use ONE of the following) ---
    uint64 to_account_id = 10 [json_name = "to_account_id"]; // Optional: Direct internal account ID
    uint64 recipient_id = 11 [json_name = "recipient_id"];   // Optional: ID of the saved recipient (internal or external)

    // --- Removed Direct External Details ---
    // ... (removed fields remain removed)
}

// Response message for initiating a transfer
message InitiateTransferResponse {
    uint64 transfer_id = 1;
    string status = 2;
    uint64 amount = 3;          // Changed to uint64 (minor units)
    uint64 fee = 4;             // Changed to uint64 (minor units)
    uint64 total_amount = 5;    // Changed to uint64 (minor units)
    google.protobuf.Timestamp created_at = 6;
}

// Time Period Enum for Statistics
enum TimePeriod {
  TIME_PERIOD_UNSPECIFIED = 0;
  TIME_PERIOD_WEEK = 1;
  TIME_PERIOD_MONTH = 2;
  TIME_PERIOD_QUARTER = 3;
  TIME_PERIOD_YEAR = 4;
  TIME_PERIOD_ALL = 5; // Or use start/end dates
}

// Represents a single point in a time series chart
message TimeSeriesPoint {
  google.protobuf.Timestamp timestamp = 1;
  double amount = 2;
}

// Represents summary data for a specific category
message CategorySummary {
  string category = 1;
  // string subcategory = 2; // Optional: Add if subcategory breakdown is needed
  double amount = 3;
  double percentage = 4; // Percentage of total income/expense for the period
}

// Represents aggregated data for a single month
message MonthlyData {
  string month = 1; // e.g., "Jan", "Feb" or "YYYY-MM"
  double income = 2;
  double expenses = 3;
}

// Represents data for month-over-month comparison
message ComparisonData {
  double current_income = 1;
  double previous_income = 2;
  double current_expenses = 3;
  double previous_expenses = 4;
  double current_savings = 5; // Calculated: current_income - current_expenses
  double previous_savings = 6; // Calculated: previous_income - previous_expenses
}

// Request message for fetching statistics
message GetStatisticsRequest {
   option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      required: ["time_period"]
    }
  };
  TimePeriod time_period = 1;
  // google.protobuf.Timestamp start_date = 2; // Alternative to TimePeriod
  // google.protobuf.Timestamp end_date = 3;   // Alternative to TimePeriod
  string currency = 4; // Optional: Filter by currency
}

// Response message containing calculated statistics
message GetStatisticsResponse {
  double total_income = 1;
  double total_expenses = 2;
  repeated TimeSeriesPoint expense_timeseries = 3;     // For expense line chart
  repeated CategorySummary expense_breakdown = 4;    // For expense pie chart/list
  repeated CategorySummary income_breakdown = 5;     // For income pie chart/list
  repeated MonthlyData monthly_overview = 6;        // For monthly bar chart (e.g., last 6 months)
  ComparisonData comparison_metrics = 7;           // For MoM comparison
}

// --- Transaction History ---

message PaginationInfo {
  int32 current_page = 1;
  int32 page_size = 2;
  int32 total_pages = 3;
  int64 total_items = 4;
}

// Request message for fetching transaction history
message GetTransactionsRequest {
   option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      // Define required/optional fields if needed for OpenAPI
    }
  };
  // Filtering Options
  uint64 account_id = 1;            // Optional: Filter by specific account ID
  string card_id = 2;               // Optional: Filter by specific card ID (will lookup linked account)
  google.protobuf.Timestamp start_date = 3; // Optional: Start of date range
  google.protobuf.Timestamp end_date = 4;   // Optional: End of date range
  TransferType transfer_type = 5;   // Optional: Filter by type (INCOME, EXPENSE, INTERNAL)
  string category = 6;              // Optional: Filter by category

  // Pagination Options
  int32 page_number = 10;           // Defaults to 1 if not provided
  int32 page_size = 11;             // Defaults to a server-defined size (e.g., 20) if not provided
}

// Response message containing transaction history
message GetTransactionsResponse {
  repeated TransferTransaction transactions = 1;
  PaginationInfo pagination = 2;
}

// Request message for getting transfer details
message GetTransferDetailsRequest {
    uint64 transfer_id = 1 [json_name = "transfer_id"]; // ID of the transfer to retrieve
}

// Response message containing transfer details
message GetTransferDetailsResponse {
    uint64 transfer_id = 1 [json_name = "transfer_id"];
    uint64 from_account_id = 2 [json_name = "from_account_id"];
    uint64 to_account_id = 3 [json_name = "to_account_id"];
    uint64 from_user_id = 4 [json_name = "from_user_id"]; // Added for context
    uint64 to_user_id = 5 [json_name = "to_user_id"];     // Added for context
    uint64 amount = 6;          // Amount in minor units
    uint64 fee = 7;             // Fee in minor units
    uint64 total_amount = 8;    // Total amount in minor units
    string currency = 9;        // Added currency
    string status = 10;         // Status string (e.g., "pending", "completed")
    string reference = 11;
    string category = 12;
    google.protobuf.Timestamp created_at = 13 [json_name = "created_at"];
    google.protobuf.Timestamp scheduled_at = 14 [json_name = "scheduled_at"]; // Null if not scheduled
    google.protobuf.Timestamp completed_at = 15 [json_name = "completed_at"]; // Null if not completed
    google.protobuf.Timestamp failed_at = 16 [json_name = "failed_at"];    // Null if not failed
    string failure_reason = 17 [json_name = "failure_reason"];    // Empty if not failed
}

// Service definition for transfers
service TransferService {
    // Initiates a new transfer
    rpc InitiateTransfer(InitiateTransferRequest) returns (InitiateTransferResponse) {
        option (google.api.http) = {
            post: "/v1/transfers"
            body: "*"
        };
        option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
            summary: "Initiate a new transfer"
            description: "Initiates a new transfer with the provided details"
            tags: "transfers"
        };      
    };

    // Fetches aggregated financial statistics based on transfer history.
    rpc GetStatistics (GetStatisticsRequest) returns (GetStatisticsResponse) {
        option (google.api.http) = {
            get: "/v1/transfers/statistics"
            // query parameters will be mapped from GetStatisticsRequest fields
        };
        option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
            summary: "Get Financial Statistics"
            description: "Retrieves aggregated income, expense, and categorized statistics based on transfer history for a given time period."
            tags: ["Transfers"]
            security: {
                security_requirement: {
                    key: "bearer"
                }
            }
        };
    }

    // Fetches a paginated list of transactions based on filter criteria.
    rpc GetTransactions (GetTransactionsRequest) returns (GetTransactionsResponse) {
      option (google.api.http) = {
        get: "/v1/transactions" // Changed path for clarity
        // Query parameters mapped from GetTransactionsRequest fields
      };
      option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
        summary: "Get Transaction History"
        description: "Retrieves a paginated list of user transactions, allowing filtering by account, card, date range, type, and category."
        tags: ["Transactions"] // Changed tag
        security: {
          security_requirement: {
            key: "bearer"
          }
        }
      };
    }

    // Retrieves the details of a specific transfer transaction.
    rpc GetTransferDetails (GetTransferDetailsRequest) returns (GetTransferDetailsResponse) {
        option (google.api.http) = {
            get: "/v1/transfers/{transfer_id}" // Map GET request with transfer_id in path
        };
        option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
            summary: "Get Transfer Details"
            description: "Retrieves the details of a specific transfer transaction by its ID."
            tags: ["Transfers"]
            security: {
                security_requirement: {
                    key: "bearer"
                }
            }
        };
    }
} 