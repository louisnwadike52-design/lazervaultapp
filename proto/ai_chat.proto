syntax = "proto3";

package pb;

import "google/api/annotations.proto"; // For potential HTTP bindings
import "protoc-gen-openapiv2/options/annotations.proto"; // For OpenAPI documentation

option go_package = "lazervaultGo/pb";

// OpenAPI documentation definition for AIChatService
option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = {
	info: {
		title: "LazerVault AI Chat Service";
		version: "1.0";
		contact: {
			name: "LazerVault";
			url: "https://github.com/LazerVault";
		};
	};
	responses: {
		key: "401";
		value: {
			description: "Returned when the user is not authenticated.";
		}
    }
    responses: {
		key: "503";
		value: {
			description: "Returned when the external AI service is unavailable or fails.";
		}
    }
};

// Request message for the AI Chat endpoint
message ProcessChatRequest {
   option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
		json_schema: {
			title: "AI Process Chat Request";
			description: "Payload containing the user's query for the AI chatbot with optional file.";
			required: ["query", "user_id"];
		}
	};
  string query = 1 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "The user's input/query to the AI."}];
  string tx_history = 2 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "JSON string containing the last 5 transactions."}];
  uint32 user_id = 3 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "The ID of the user making the request."}];

  // Optional file handling field
  optional ChatFile uploaded_file = 4 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Optional file uploaded by the user for AI processing."}];
}

// Response message for the AI Chat endpoint
message ProcessChatResponse {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
		json_schema: {
			title: "AI Process Chat Response";
			description: "Contains the AI chatbot's response along with status.";
		}
	};
  bool success = 1 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Indicates if the query was successfully processed."}];
  string msg = 2 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "A status message related to the processing."}];
  string query = 3 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "The original query sent by the user."}];
  string response = 4 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "The AI's response."}];

  // Optional file handling response fields (for future AI service enhancements)
  repeated ChatFile generated_files = 5 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Files generated by the AI in response to the query."}];
  FileAnalysis file_analysis = 6 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Analysis results of uploaded files."}];
}

// Represents a file in chat context
message ChatFile {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
		json_schema: {
			title: "Chat File";
			description: "Represents a file in the chat context (for upload or download).";
		}
	};
  // For uploads - client provides these fields
  string filename = 1 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Original filename (required for uploads)."}];
  string content_type = 2 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "MIME type of the file (required for uploads)."}];
  bytes file_content = 3 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Binary content of the file (required for uploads)."}];

  // For responses - server provides these fields
  string file_id = 4 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Unique identifier for the file (set by server)."}];
  string file_url = 5 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "URL to access the file (set by server for downloads/generated files)."}];
  int64 file_size = 6 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Size of the file in bytes (set by server)."}];
  string upload_timestamp = 7 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "When the file was uploaded in RFC3339 format (set by server)."}];
}

// File analysis results from AI
message FileAnalysis {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
		json_schema: {
			title: "File Analysis";
			description: "Analysis results from AI processing of uploaded files.";
		}
	};
  repeated FileAnalysisResult results = 1 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Analysis results for each processed file."}];
  string summary = 2 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Overall summary of file analysis."}];
}

// Individual file analysis result
message FileAnalysisResult {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
		json_schema: {
			title: "File Analysis Result";
			description: "Analysis result for a single file.";
		}
	};
  string file_id = 1 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "ID of the analyzed file."}];
  string filename = 2 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Name of the analyzed file."}];
  string analysis_type = 3 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Type of analysis performed (e.g., 'text_extraction', 'image_recognition', 'data_analysis')."}];
  string analysis_result = 4 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Detailed analysis results."}];
  map<string, string> metadata = 5 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Additional metadata extracted from the file."}];
  bool processing_success = 6 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Whether file processing was successful."}];
  string error_message = 7 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Error message if processing failed."}];
}

// Request message for triggering chat history indexing for the authenticated user
message IndexChatHistoryRequest {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
		json_schema: {
			title: "Index Chat History Request";
			description: "Triggers the indexing process for the authenticated user's latest chat history file.";
        // No fields needed, user ID comes from auth context
		}
	};
  // Potentially add user_id field if needed for admin purposes later, but for now rely on auth context
}

// Response message for chat history indexing trigger
message IndexChatHistoryResponse {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
		json_schema: {
			title: "Index Chat History Response";
			description: "Response confirming the chat history indexing task was triggered.";
		}
	};
  bool success = 1 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Indicates if the indexing task was successfully triggered."}];
  string msg = 2 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "A status message (e.g., 'Indexing triggered' or 'File not found')."}];
}

// Request message for triggering transaction file indexing for the authenticated user
message IndexTransactionFileRequest {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
		json_schema: {
			title: "Index Transaction File Request";
			description: "Triggers the indexing process for the authenticated user's latest transaction file.";
        // No fields needed, user ID comes from auth context
		}
	};
   // Potentially add user_id field if needed for admin purposes later
}

// Response message for transaction file indexing trigger
message IndexTransactionFileResponse {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
		json_schema: {
			title: "Index Transaction File Response";
			description: "Response confirming the transaction file indexing task was triggered.";
		}
	};
  bool success = 1 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Indicates if the indexing task was successfully triggered."}];
  string msg = 2 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "A status message (e.g., 'Indexing triggered' or 'File not found')."}];
}

// Represents a single entry in the AI chat history
message AIChatHistoryEntry {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
		json_schema: {
			title: "AI Chat History Entry";
			description: "A single query-response pair from the AI chat history.";
		}
	};
  string query = 1 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "The user's query."}];
  string response = 2 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "The AI's response."}];
  string timestamp = 3 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Timestamp of the interaction (RFC3339 format)."}];
}

// Request message for getting the user's AI chat history
message GetAIChatHistoryRequest {
 option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
		json_schema: {
			title: "Get AI Chat History Request";
			description: "Request to fetch the AI chat history for the authenticated user.";
      // No fields needed, user ID comes from auth context
		}
	};
  // Potential future additions: pagination (limit, offset)
}

// Response message containing the user's AI chat history
message GetAIChatHistoryResponse {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
		json_schema: {
			title: "Get AI Chat History Response";
			description: "A list of AI chat history entries for the user.";
		}
	};
  repeated AIChatHistoryEntry history = 1 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "List of AI chat history entries, ordered chronologically."}];
}

// Service definition for AI chat interactions
service AIChatService {
  // Processes a user's query using an external AI chatbot, leveraging user context.
  rpc ProcessChat(ProcessChatRequest) returns (ProcessChatResponse) {
    option (google.api.http) = {
      post: "/v1/ai/chat"
      body: "*"
    };
     option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
			description: "Sends the user's query to the AI chatbot, along with contextual user transaction data (fetched server-side), and returns the AI's response.";
			summary: "Process AI Chat Query";
            tags: ["AI Chat"];
            responses: {
                key: "200";
                value: {
                    description: "OK - AI response received.";
                    schema: {
                        json_schema: {
                           ref: "#/definitions/pbProcessChatResponse";
                        }
                    }
                }
            }
            // Add 400, 401, 404 (user/tx file not found), 500, 503 responses
		};
  }

  // Triggers indexing for the authenticated user's chat history file.
  rpc IndexChatHistory(IndexChatHistoryRequest) returns (IndexChatHistoryResponse) {
    option (google.api.http) = {
      post: "/v1/ai/index/chat"
      body: "*" // Body can be empty or *
    };
     option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
			description: "Triggers the indexing process for the authenticated user's latest chat history file stored in GCS.";
			summary: "Index Chat History";
            tags: ["AI Indexing"];
            responses: {
                key: "200";
                value: {
                    description: "OK - Indexing triggered or file not found (check message).";
                    schema: {
                        json_schema: {
                           ref: "#/definitions/pbIndexChatHistoryResponse";
                        }
                    }
                }
            }
            // Add 401, 500, 503 responses
		};
  }

  // Triggers indexing for the authenticated user's transaction file.
  rpc IndexTransactionFile(IndexTransactionFileRequest) returns (IndexTransactionFileResponse) {
    option (google.api.http) = {
      post: "/v1/ai/index/transactions"
      body: "*" // Body can be empty or *
    };
     option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
			description: "Triggers the indexing process for the authenticated user's latest transaction file stored in GCS.";
			summary: "Index Transaction File";
            tags: ["AI Indexing"];
             responses: {
                key: "200";
                value: {
                    description: "OK - Indexing triggered or file not found (check message).";
                    schema: {
                        json_schema: {
                           ref: "#/definitions/pbIndexTransactionFileResponse";
                        }
                    }
                }
            }
            // Add 401, 500, 503 responses
		};
  }

  // Retrieves the AI chat history for the authenticated user.
  rpc GetAIChatHistory(GetAIChatHistoryRequest) returns (GetAIChatHistoryResponse) {
    option (google.api.http) = {
      get: "/v1/ai/chat/history"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
			description: "Retrieves the AI chat history (list of query/response pairs) for the authenticated user.";
			summary: "Get AI Chat History";
            tags: ["AI Chat"];
            responses: {
                key: "200";
                value: {
                    description: "OK - AI Chat history retrieved.";
                    schema: {
                        json_schema: {
                           ref: "#/definitions/pbGetAIChatHistoryResponse";
                        }
                    }
                }
            }
             // Add 401, 500 responses
		};
  }
} 