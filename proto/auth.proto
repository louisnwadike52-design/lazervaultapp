syntax = "proto3";

package auth;

import "google/api/annotations.proto";
import "protoc-gen-openapiv2/options/annotations.proto";

option go_package = "auth-service/proto";

// OpenAPI v2 documentation
option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = {
  info: {
    title: "LazerVault Auth Service";
    version: "1.0";
    description: "Authentication and authorization service for LazerVault";
  };
  schemes: HTTP;
  schemes: HTTPS;
  consumes: "application/json";
  produces: "application/json";
  security_definitions: {
    security: {
      key: "bearer";
      value: {
        type: TYPE_API_KEY;
        in: IN_HEADER;
        name: "Authorization";
        description: "Bearer token authentication";
      }
    }
  };
};

// Auth Service - Complete authentication and authorization
service AuthService {
  // User registration
  rpc Signup(SignupRequest) returns (SignupResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/signup"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "User Registration";
      description: "Register a new user account";
      tags: ["Authentication"];
    };
  }

  // User login
  rpc Login(LoginRequest) returns (LoginResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/login"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "User Login";
      description: "Login with email and password";
      tags: ["Authentication"];
    };
  }

  // Refresh access token
  rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/refresh"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Refresh Token";
      description: "Refresh access token using refresh token";
      tags: ["Authentication"];
    };
  }

  // Logout user
  rpc Logout(LogoutRequest) returns (LogoutResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/logout"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "User Logout";
      description: "Logout and invalidate refresh token";
      tags: ["Authentication"];
      security: {
        security_requirement: {
          key: "bearer";
        }
      };
    };
  }

  // Email verification
  rpc VerifyEmail(VerifyEmailRequest) returns (VerifyEmailResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/verify-email"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Verify Email";
      description: "Verify email address with token";
      tags: ["Authentication"];
    };
  }

  // Phone verification
  rpc VerifyPhone(VerifyPhoneRequest) returns (VerifyPhoneResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/verify-phone"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Verify Phone";
      description: "Verify phone number with OTP code";
      tags: ["Authentication"];
      security: {
        security_requirement: {
          key: "bearer";
        }
      };
    };
  }

  // Request password reset
  rpc ForgotPassword(ForgotPasswordRequest) returns (ForgotPasswordResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/forgot-password"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Forgot Password";
      description: "Request password reset email";
      tags: ["Authentication"];
    };
  }

  // Reset password with token
  rpc ResetPassword(ResetPasswordRequest) returns (ResetPasswordResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/reset-password"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Reset Password";
      description: "Reset password using token from email";
      tags: ["Authentication"];
    };
  }

  // Get current user info
  rpc GetMe(GetMeRequest) returns (GetMeResponse) {
    option (google.api.http) = {
      get: "/api/v1/auth/me"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get Current User";
      description: "Get currently authenticated user information";
      tags: ["User"];
      security: {
        security_requirement: {
          key: "bearer";
        }
      };
    };
  }

  // Facial recognition login
  rpc FacialLogin(FacialLoginRequest) returns (FacialLoginResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/facial-login"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Facial Login";
      description: "Login using facial recognition";
      tags: ["Authentication"];
    };
  }

  // Social login (Google, Facebook, Apple)
  rpc SocialLogin(SocialLoginRequest) returns (SocialLoginResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/social-login"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Social Login";
      description: "Login with social provider (Google, Facebook, Apple)";
      tags: ["Authentication"];
    };
  }

  // Enable two-factor authentication
  rpc EnableTwoFactor(EnableTwoFactorRequest) returns (EnableTwoFactorResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/2fa/enable"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Enable 2FA";
      description: "Enable two-factor authentication";
      tags: ["Two-Factor Authentication"];
      security: {
        security_requirement: {
          key: "bearer";
        }
      };
    };
  }

  // Verify two-factor authentication
  rpc VerifyTwoFactor(VerifyTwoFactorRequest) returns (VerifyTwoFactorResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/2fa/verify"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Verify 2FA";
      description: "Verify two-factor authentication code";
      tags: ["Two-Factor Authentication"];
    };
  }

  // Validate token (used by gateway)
  rpc ValidateToken(ValidateTokenRequest) returns (ValidateTokenResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/validate-token"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Validate Token";
      description: "Validate JWT token (internal use by gateway)";
      tags: ["Internal"];
    };
  }

  // Resend verification email
  rpc ResendVerificationEmail(ResendVerificationEmailRequest) returns (ResendVerificationEmailResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/resend-verification"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Resend Verification Email";
      description: "Resend email verification link";
      tags: ["Authentication"];
    };
  }

  // Resend phone verification SMS
  rpc ResendPhoneVerification(ResendPhoneVerificationRequest) returns (ResendPhoneVerificationResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/resend-phone-verification"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Resend Phone Verification";
      description: "Resend phone verification SMS code";
      tags: ["Authentication"];
    };
  }

  // Change password (authenticated)
  rpc ChangePassword(ChangePasswordRequest) returns (ChangePasswordResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/change-password"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Change Password";
      description: "Change password for authenticated user";
      tags: ["User"];
      security: {
        security_requirement: {
          key: "bearer";
        }
      };
    };
  }

  // Login with passcode
  rpc LoginWithPasscode(LoginWithPasscodeRequest) returns (LoginResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/login-passcode"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Login with Passcode";
      description: "Login using passcode instead of password";
      tags: ["Authentication"];
    };
  }

  // Register passcode
  rpc RegisterPasscode(RegisterPasscodeRequest) returns (RegisterPasscodeResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/register-passcode"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Register Passcode";
      description: "Register a passcode for quick login";
      tags: ["Authentication"];
      security: {
        security_requirement: {
          key: "bearer";
        }
      };
    };
  }

  // Change passcode
  rpc ChangePasscode(ChangePasscodeRequest) returns (ChangePasscodeResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/change-passcode"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Change Passcode";
      description: "Change user passcode";
      tags: ["Authentication"];
      security: {
        security_requirement: {
          key: "bearer";
        }
      };
    };
  }

  // Request password reset
  rpc RequestPasswordReset(RequestPasswordResetRequest) returns (RequestPasswordResetResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/request-password-reset"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Request Password Reset";
      description: "Request password reset email";
      tags: ["Authentication"];
    };
  }

  // Request email verification
  rpc RequestEmailVerification(RequestEmailVerificationRequest) returns (RequestEmailVerificationResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/request-email-verification"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Request Email Verification";
      description: "Request email verification email";
      tags: ["Authentication"];
    };
  }

  // Check email availability
  rpc CheckEmailAvailability(CheckEmailAvailabilityRequest) returns (CheckEmailAvailabilityResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/check-email-availability"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Check Email Availability";
      description: "Check if email is available for registration";
      tags: ["Authentication"];
    };
  }

  // Request phone verification
  rpc RequestPhoneVerification(RequestPhoneVerificationRequest) returns (RequestPhoneVerificationResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/request-phone-verification"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Request Phone Verification";
      description: "Request phone verification code";
      tags: ["Authentication"];
    };
  }

  // Verify phone number
  rpc VerifyPhoneNumber(VerifyPhoneNumberRequest) returns (VerifyPhoneNumberResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/verify-phone-number"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Verify Phone Number";
      description: "Verify phone number with code";
      tags: ["Authentication"];
    };
  }

  // Get signup progress
  rpc GetSignupProgress(GetSignupProgressRequest) returns (GetSignupProgressResponse) {
    option (google.api.http) = {
      get: "/api/v1/auth/signup-progress"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get Signup Progress";
      description: "Get signup progress for authenticated user";
      tags: ["Signup"];
      security: {
        security_requirement: {
          key: "bearer";
        }
      };
    };
  }

  // Update signup step
  rpc UpdateSignupStep(UpdateSignupStepRequest) returns (UpdateSignupStepResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/signup-progress/step"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Update Signup Step";
      description: "Update signup step progress";
      tags: ["Signup"];
      security: {
        security_requirement: {
          key: "bearer";
        }
      };
    };
  }

  // Complete signup
  rpc CompleteSignup(CompleteSignupRequest) returns (CompleteSignupResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/signup-progress/complete"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Complete Signup";
      description: "Mark signup as complete";
      tags: ["Signup"];
      security: {
        security_requirement: {
          key: "bearer";
        }
      };
    };
  }
}

// ===== Signup =====
// Enum to specify primary contact method for signup
enum PrimaryContactType {
  EMAIL = 0;   // User signed up with email (default)
  PHONE = 1;   // User signed up with phone number
}

message SignupRequest {
  string email = 1;
  string password = 2;
  string first_name = 3;
  string last_name = 4;
  string phone = 5;                              // E.164 format (e.g., +12345678901)
  string country_code = 6;                       // ISO country code (e.g., "US")
  string device_id = 7;
  string device_name = 8;
  PrimaryContactType primary_contact_type = 9;   // Which contact method user chose first
  string username = 10;                          // Optional username
  string referral_code = 11;                     // Optional referral code
  string date_of_birth = 12;                     // ISO 8601 date (YYYY-MM-DD)
}

message SignupResponse {
  string user_id = 1;
  string email = 2;
  string message = 3;
  bool email_verification_required = 4;          // True if email needs verification
  string access_token = 5;
  string refresh_token = 6;
  int64 expires_in = 7;
  User user = 8;
  bool phone_verification_required = 9;          // True if phone needs verification
  string verification_sent_to = 10;              // Email or phone where verification was sent
}

// ===== Login =====
message LoginRequest {
  string email = 1;                 // Email OR phone number (specify one)
  string password = 2;
  string device_id = 3;
  string device_name = 4;
  string phone = 5;                 // Alternative to email for login
}

message LoginResponse {
  bool success = 1;
  string msg = 2;
  string access_token = 3;
  string refresh_token = 4;
  int64 expires_in = 5;
  LoginData data = 6;
  bool two_factor_required = 7;
  string two_factor_token = 8; // Temporary token for 2FA flow
}

message LoginData {
  User user = 1;
  Session session = 2;
}

message Session {
  string access_token = 1;
  string refresh_token = 2;
  int64 expires_in = 3;
  string user_id = 4;
}

// ===== Refresh Token =====
message RefreshTokenRequest {
  string refresh_token = 1;
}

message RefreshTokenResponse {
  string access_token = 1;
  string refresh_token = 2;
  int64 expires_in = 3;
  User user = 4;
}

// ===== Logout =====
message LogoutRequest {
  string user_id = 1;
  string refresh_token = 2;
}

message LogoutResponse {
  string message = 1;
}

// ===== Email Verification =====
message VerifyEmailRequest {
  string verificationCode = 1;
}

message VerifyEmailResponse {
  string msg = 1;
  bool success = 2;
}

message ResendVerificationEmailRequest {
  string email = 1;
}

message ResendVerificationEmailResponse {
  bool success = 1;
  string message = 2;
  int32 cooldown_seconds = 3;           // Seconds to wait before next resend (60s default)
}

// ===== Phone Verification =====
message VerifyPhoneRequest {
  string user_id = 1;
  string code = 2;
  string phone = 3;                    // Phone number to verify (E.164 format)
}

message VerifyPhoneResponse {
  string message = 1;
  bool success = 2;
}

message ResendPhoneVerificationRequest {
  string phone = 1;                    // Phone number in E.164 format
  string user_id = 2;                  // Optional user ID
}

message ResendPhoneVerificationResponse {
  string message = 1;
  bool success = 2;
}

// ===== Password Reset =====
message ForgotPasswordRequest {
  string email = 1;
}

message ForgotPasswordResponse {
  string message = 1;
}

message ResetPasswordRequest {
  string token = 1;
  string new_password = 2;
}

message ResetPasswordResponse {
  string msg = 1;
  bool success = 2;
}

message ChangePasswordRequest {
  string user_id = 1;
  string current_password = 2;
  string new_password = 3;
}

message ChangePasswordResponse {
  string message = 1;
}

// ===== Get User Info =====
message GetMeRequest {
  string user_id = 1;
}

message GetMeResponse {
  User user = 1;
}

// ===== Facial Login =====
message FacialLoginRequest {
  bytes facial_data = 1;
  string device_id = 2;
}

message FacialLoginResponse {
  string access_token = 1;
  string refresh_token = 2;
  int64 expires_in = 3;
  User user = 4;
}

// ===== Social Login =====
message SocialLoginRequest {
  string provider = 1; // "google", "facebook", "apple"
  string provider_token = 2;
  string email = 3;
  string first_name = 4;
  string last_name = 5;
  string provider_user_id = 6;
}

message SocialLoginResponse {
  string access_token = 1;
  string refresh_token = 2;
  int64 expires_in = 3;
  User user = 4;
  bool is_new_user = 5;
}

// ===== Two-Factor Authentication =====
message EnableTwoFactorRequest {
  string user_id = 1;
  string method = 2; // "sms", "email", "totp"
}

message EnableTwoFactorResponse {
  string message = 1;
  string qr_code = 2; // For TOTP
  string secret = 3; // For TOTP
}

message VerifyTwoFactorRequest {
  string two_factor_token = 1; // From login response
  string code = 2;
  string method = 3;
}

message VerifyTwoFactorResponse {
  string access_token = 1;
  string refresh_token = 2;
  int64 expires_in = 3;
  User user = 4;
}

// ===== Validate Token (for gateway) =====
message ValidateTokenRequest {
  string token = 1;
}

message ValidateTokenResponse {
  bool valid = 1;
  string user_id = 2;
  string email = 3;
  int64 expires_at = 4;
}

// ===== Passcode Login =====
message LoginWithPasscodeRequest {
  string email = 1;
  string passcode = 2;
  string device_id = 3;
  string device_name = 4;
}

message RegisterPasscodeRequest {
  string passcode = 1;
}

message RegisterPasscodeResponse {
  bool success = 1;
  string msg = 2;
}

message ChangePasscodeRequest {
  string current_passcode = 1;
  string new_passcode = 2;
}

message ChangePasscodeResponse {
  bool success = 1;
  string msg = 2;
}

// ===== Password Reset =====
message RequestPasswordResetRequest {
  string email = 1;
}

message RequestPasswordResetResponse {
  bool success = 1;
  string msg = 2;
}

// ===== Email Verification Request =====
message RequestEmailVerificationRequest {
  string email = 1;
}

message RequestEmailVerificationResponse {
  bool success = 1;
  string msg = 2;
}

// ===== Email Availability Check =====
message CheckEmailAvailabilityRequest {
  string email = 1;
}

message CheckEmailAvailabilityResponse {
  bool available = 1;
  string msg = 2;
}

// ===== Phone Verification =====
message RequestPhoneVerificationRequest {
  string phone = 1;
  string country_code = 2;
}

message RequestPhoneVerificationResponse {
  bool success = 1;
  string msg = 2;
  string verification_id = 3;
  int64 expires_in = 4;
}

message VerifyPhoneNumberRequest {
  string phone = 1;
  string country_code = 2;
  string code = 3;
  string verification_id = 4;
}

message VerifyPhoneNumberResponse {
  bool success = 1;
  string msg = 2;
  bool is_verified = 3;
}

// ===== User Model =====
message User {
  string id = 1;
  string email = 2;
  string first_name = 3;
  string last_name = 4;
  string phone = 5;
  string country_code = 6;
  bool email_verified = 7;
  bool phone_verified = 8;
  bool two_factor_enabled = 9;
  string two_factor_method = 10;
  string profile_picture = 11;
  string created_at = 12;
  string updated_at = 13;
}

// ===== Signup Progress =====
enum SignupStatus {
  SIGNUP_STATUS_CREATED = 0;
  SIGNUP_STATUS_EMAIL_VERIFIED = 1;
  SIGNUP_STATUS_PHONE_VERIFIED = 2;
  SIGNUP_STATUS_PASSCODE_SET = 3;
  SIGNUP_STATUS_COMPLETE = 4;
}

enum StepStatus {
  STEP_STATUS_PENDING = 0;
  STEP_STATUS_IN_PROGRESS = 1;
  STEP_STATUS_COMPLETED = 2;
  STEP_STATUS_SKIPPED = 3;
}

message SignupProgress {
  string user_id = 1;
  SignupStatus status = 2;
  string current_step = 3;
  repeated SignupStepProgress steps = 4;
  string created_at = 5;
  string updated_at = 6;
  string completed_at = 7;
}

message SignupStepProgress {
  string step_name = 1;
  StepStatus status = 2;
  string step_data = 3;           // JSON string with step-specific data
  string completed_at = 4;
}

message GetSignupProgressRequest {
  // User ID is extracted from the JWT token
}

message GetSignupProgressResponse {
  bool success = 1;
  string message = 2;
  SignupProgress progress = 3;
}

message UpdateSignupStepRequest {
  string step_name = 1;
  StepStatus status = 2;
  string step_data = 3;           // JSON string with step-specific data
}

message UpdateSignupStepResponse {
  bool success = 1;
  string message = 2;
  SignupProgress progress = 3;
}

message CompleteSignupRequest {
  // User ID is extracted from the JWT token
}

message CompleteSignupResponse {
  bool success = 1;
  string message = 2;
  SignupProgress progress = 3;
}
