syntax = "proto3";

package auth;

import "google/api/annotations.proto";
import "protoc-gen-openapiv2/options/annotations.proto";

option go_package = "auth-service/proto";

// OpenAPI v2 documentation
option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = {
  info: {
    title: "LazerVault Auth Service";
    version: "1.0";
    description: "Authentication and authorization service for LazerVault";
  };
  schemes: HTTP;
  schemes: HTTPS;
  consumes: "application/json";
  produces: "application/json";
  security_definitions: {
    security: {
      key: "bearer";
      value: {
        type: TYPE_API_KEY;
        in: IN_HEADER;
        name: "Authorization";
        description: "Bearer token authentication";
      }
    }
  };
};

// Auth Service - Complete authentication and authorization
service AuthService {
  // User registration
  rpc Signup(SignupRequest) returns (SignupResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/signup"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "User Registration";
      description: "Register a new user account";
      tags: ["Authentication"];
    };
  }

  // User login
  rpc Login(LoginRequest) returns (LoginResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/login"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "User Login";
      description: "Login with email and password";
      tags: ["Authentication"];
    };
  }

  // Refresh access token
  rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/refresh"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Refresh Token";
      description: "Refresh access token using refresh token";
      tags: ["Authentication"];
    };
  }

  // Logout user
  rpc Logout(LogoutRequest) returns (LogoutResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/logout"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "User Logout";
      description: "Logout and invalidate refresh token";
      tags: ["Authentication"];
      security: {
        security_requirement: {
          key: "bearer";
        }
      };
    };
  }

  // Email verification
  rpc VerifyEmail(VerifyEmailRequest) returns (VerifyEmailResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/verify-email"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Verify Email";
      description: "Verify email address with token";
      tags: ["Authentication"];
    };
  }

  // Phone verification
  rpc VerifyPhone(VerifyPhoneRequest) returns (VerifyPhoneResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/verify-phone"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Verify Phone";
      description: "Verify phone number with OTP code";
      tags: ["Authentication"];
      security: {
        security_requirement: {
          key: "bearer";
        }
      };
    };
  }

  // Request password reset
  rpc ForgotPassword(ForgotPasswordRequest) returns (ForgotPasswordResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/forgot-password"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Forgot Password";
      description: "Request password reset email";
      tags: ["Authentication"];
    };
  }

  // Reset password with token
  rpc ResetPassword(ResetPasswordRequest) returns (ResetPasswordResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/reset-password"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Reset Password";
      description: "Reset password using token from email";
      tags: ["Authentication"];
    };
  }

  // Get current user info
  rpc GetMe(GetMeRequest) returns (GetMeResponse) {
    option (google.api.http) = {
      get: "/api/v1/auth/me"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get Current User";
      description: "Get currently authenticated user information";
      tags: ["User"];
      security: {
        security_requirement: {
          key: "bearer";
        }
      };
    };
  }

  // Facial recognition login
  rpc FacialLogin(FacialLoginRequest) returns (FacialLoginResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/facial-login"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Facial Login";
      description: "Login using facial recognition";
      tags: ["Authentication"];
    };
  }

  // Social login (Google, Facebook, Apple)
  rpc SocialLogin(SocialLoginRequest) returns (SocialLoginResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/social-login"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Social Login";
      description: "Login with social provider (Google, Facebook, Apple)";
      tags: ["Authentication"];
    };
  }

  // Enable two-factor authentication
  rpc EnableTwoFactor(EnableTwoFactorRequest) returns (EnableTwoFactorResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/2fa/enable"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Enable 2FA";
      description: "Enable two-factor authentication";
      tags: ["Two-Factor Authentication"];
      security: {
        security_requirement: {
          key: "bearer";
        }
      };
    };
  }

  // Verify two-factor authentication
  rpc VerifyTwoFactor(VerifyTwoFactorRequest) returns (VerifyTwoFactorResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/2fa/verify"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Verify 2FA";
      description: "Verify two-factor authentication code";
      tags: ["Two-Factor Authentication"];
    };
  }

  // Validate token (used by gateway)
  rpc ValidateToken(ValidateTokenRequest) returns (ValidateTokenResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/validate-token"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Validate Token";
      description: "Validate JWT token (internal use by gateway)";
      tags: ["Internal"];
    };
  }

  // Resend verification email
  rpc ResendVerificationEmail(ResendVerificationEmailRequest) returns (ResendVerificationEmailResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/resend-verification"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Resend Verification Email";
      description: "Resend email verification link";
      tags: ["Authentication"];
    };
  }

  // Change password (authenticated)
  rpc ChangePassword(ChangePasswordRequest) returns (ChangePasswordResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/change-password"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Change Password";
      description: "Change password for authenticated user";
      tags: ["User"];
      security: {
        security_requirement: {
          key: "bearer";
        }
      };
    };
  }
}

// ===== Signup =====
message SignupRequest {
  string email = 1;
  string password = 2;
  string first_name = 3;
  string last_name = 4;
  string phone = 5;
  string country_code = 6;
  string device_id = 7;
  string device_name = 8;
}

message SignupResponse {
  string user_id = 1;
  string email = 2;
  string message = 3;
  bool email_verification_required = 4;
  string access_token = 5;
  string refresh_token = 6;
  int64 expires_in = 7;
  User user = 8;
}

// ===== Login =====
message LoginRequest {
  string email = 1;
  string password = 2;
  string device_id = 3;
  string device_name = 4;
}

message LoginResponse {
  string access_token = 1;
  string refresh_token = 2;
  int64 expires_in = 3;
  User user = 4;
  bool two_factor_required = 5;
  string two_factor_token = 6; // Temporary token for 2FA flow
}

// ===== Refresh Token =====
message RefreshTokenRequest {
  string refresh_token = 1;
}

message RefreshTokenResponse {
  string access_token = 1;
  string refresh_token = 2;
  int64 expires_in = 3;
}

// ===== Logout =====
message LogoutRequest {
  string user_id = 1;
  string refresh_token = 2;
}

message LogoutResponse {
  string message = 1;
}

// ===== Email Verification =====
message VerifyEmailRequest {
  string token = 1;
}

message VerifyEmailResponse {
  string message = 1;
  bool success = 2;
}

message ResendVerificationEmailRequest {
  string email = 1;
}

message ResendVerificationEmailResponse {
  string message = 1;
}

// ===== Phone Verification =====
message VerifyPhoneRequest {
  string user_id = 1;
  string code = 2;
}

message VerifyPhoneResponse {
  string message = 1;
  bool success = 2;
}

// ===== Password Reset =====
message ForgotPasswordRequest {
  string email = 1;
}

message ForgotPasswordResponse {
  string message = 1;
}

message ResetPasswordRequest {
  string token = 1;
  string new_password = 2;
}

message ResetPasswordResponse {
  string message = 1;
  bool success = 2;
}

message ChangePasswordRequest {
  string user_id = 1;
  string current_password = 2;
  string new_password = 3;
}

message ChangePasswordResponse {
  string message = 1;
}

// ===== Get User Info =====
message GetMeRequest {
  string user_id = 1;
}

message GetMeResponse {
  User user = 1;
}

// ===== Facial Login =====
message FacialLoginRequest {
  bytes facial_data = 1;
  string device_id = 2;
}

message FacialLoginResponse {
  string access_token = 1;
  string refresh_token = 2;
  int64 expires_in = 3;
  User user = 4;
}

// ===== Social Login =====
message SocialLoginRequest {
  string provider = 1; // "google", "facebook", "apple"
  string provider_token = 2;
  string email = 3;
  string first_name = 4;
  string last_name = 5;
  string provider_user_id = 6;
}

message SocialLoginResponse {
  string access_token = 1;
  string refresh_token = 2;
  int64 expires_in = 3;
  User user = 4;
  bool is_new_user = 5;
}

// ===== Two-Factor Authentication =====
message EnableTwoFactorRequest {
  string user_id = 1;
  string method = 2; // "sms", "email", "totp"
}

message EnableTwoFactorResponse {
  string message = 1;
  string qr_code = 2; // For TOTP
  string secret = 3; // For TOTP
}

message VerifyTwoFactorRequest {
  string two_factor_token = 1; // From login response
  string code = 2;
  string method = 3;
}

message VerifyTwoFactorResponse {
  string access_token = 1;
  string refresh_token = 2;
  int64 expires_in = 3;
  User user = 4;
}

// ===== Validate Token (for gateway) =====
message ValidateTokenRequest {
  string token = 1;
}

message ValidateTokenResponse {
  bool valid = 1;
  string user_id = 2;
  string email = 3;
  int64 expires_at = 4;
}

// ===== User Model =====
message User {
  string id = 1;
  string email = 2;
  string first_name = 3;
  string last_name = 4;
  string phone = 5;
  string country_code = 6;
  bool email_verified = 7;
  bool phone_verified = 8;
  bool two_factor_enabled = 9;
  string two_factor_method = 10;
  string profile_picture = 11;
  string created_at = 12;
  string updated_at = 13;
}
