syntax = "proto3";

package pb;

option go_package = "lazervaultGo/pb";

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";

// ============================================================================
// ENUMS
// ============================================================================

enum CrowdfundStatus {
  CROWDFUND_STATUS_UNSPECIFIED = 0;
  CROWDFUND_STATUS_ACTIVE = 1;
  CROWDFUND_STATUS_PAUSED = 2;
  CROWDFUND_STATUS_COMPLETED = 3;
  CROWDFUND_STATUS_CANCELLED = 4;
}

enum CrowdfundVisibility {
  CROWDFUND_VISIBILITY_UNSPECIFIED = 0;
  CROWDFUND_VISIBILITY_PUBLIC = 1;
  CROWDFUND_VISIBILITY_PRIVATE = 2;
  CROWDFUND_VISIBILITY_UNLISTED = 3;
}

enum DonationStatus {
  DONATION_STATUS_UNSPECIFIED = 0;
  DONATION_STATUS_PENDING = 1;
  DONATION_STATUS_PROCESSING = 2;
  DONATION_STATUS_COMPLETED = 3;
  DONATION_STATUS_FAILED = 4;
  DONATION_STATUS_REFUNDED = 5;
}

// ============================================================================
// MESSAGES
// ============================================================================

message CrowdfundCreatorMessage {
  uint64 user_id = 1;
  string username = 2;
  string first_name = 3;
  string last_name = 4;
  string profile_picture = 5;
  bool verified = 6;
  google.protobuf.Timestamp verified_at = 7;
  bool facial_recognition_enabled = 8;
}

message CrowdfundMessage {
  string id = 1;
  uint64 creator_user_id = 2;
  CrowdfundCreatorMessage creator = 3;
  string title = 4;
  string description = 5;
  string story = 6;
  string crowdfund_code = 7;
  uint64 target_amount = 8;
  uint64 current_amount = 9;
  string currency = 10;
  google.protobuf.Timestamp deadline = 11;
  string category = 12;
  CrowdfundStatus status = 13;
  string image_url = 14;
  CrowdfundVisibility visibility = 15;
  string metadata = 16; // JSON string
  int32 donor_count = 17;
  double progress_percentage = 18;
  google.protobuf.Timestamp created_at = 19;
  google.protobuf.Timestamp updated_at = 20;
  repeated CrowdfundDonationMessage recent_donations = 21; // Top 5
}

message CrowdfundDonorMessage {
  uint64 user_id = 1;
  string display_name = 2; // Abstracted or full based on context
  string profile_picture = 3;
  bool is_anonymous = 4;
  bool is_creator = 5; // True if viewing as crowdfund creator
}

message CrowdfundDonationMessage {
  string id = 1;
  string crowdfund_id = 2;
  uint64 donor_user_id = 3;
  CrowdfundDonorMessage donor = 4;
  uint64 amount = 5;
  string currency = 6;
  google.protobuf.Timestamp donation_date = 7;
  DonationStatus status = 8;
  string transaction_id = 9;
  string receipt_id = 10;
  string message = 11;
  bool is_anonymous = 12;
  string payment_method = 13;
  string metadata = 14; // JSON string
}

message CrowdfundReceiptMessage {
  string id = 1;
  string donation_id = 2;
  string crowdfund_id = 3;
  string crowdfund_title = 4;
  uint64 donor_user_id = 5;
  string donor_name = 6;
  uint64 amount = 7;
  string currency = 8;
  google.protobuf.Timestamp donation_date = 9;
  google.protobuf.Timestamp generated_at = 10;
  string receipt_number = 11;
  string receipt_data = 12; // JSON string
}

// ============================================================================
// REQUEST/RESPONSE MESSAGES
// ============================================================================

// Create Crowdfund
message CreateCrowdfundRequest {
  string title = 1;
  string description = 2;
  string story = 3;
  uint64 target_amount = 4;
  string currency = 5;
  google.protobuf.Timestamp deadline = 6;
  string category = 7;
  string image_url = 8;
  CrowdfundVisibility visibility = 9;
  string metadata = 10;
}

message CreateCrowdfundResponse {
  CrowdfundMessage crowdfund = 1;
}

// Get Crowdfund
message GetCrowdfundRequest {
  string crowdfund_id = 1;
}

message GetCrowdfundResponse {
  CrowdfundMessage crowdfund = 1;
}

// List Crowdfunds
message ListCrowdfundsRequest {
  int32 page = 1;
  int32 page_size = 2;
  string status = 3; // Optional filter
  string category = 4; // Optional filter
  bool my_crowdfunds_only = 5; // Filter to user's own crowdfunds
  string sort_by = 6; // "trending", "most_funded", "newest", "ending_soon"
  CrowdfundVisibility visibility = 7; // Filter by visibility (e.g. PUBLIC for discovery)
}

message ListCrowdfundsResponse {
  repeated CrowdfundMessage crowdfunds = 1;
  CrowdfundPaginationInfo pagination = 2;
}

// Search Crowdfunds
message SearchCrowdfundsRequest {
  string query = 1; // Search by username or crowdfund code
  int32 limit = 2;
}

message SearchCrowdfundsResponse {
  repeated CrowdfundMessage crowdfunds = 1;
}

// Update Crowdfund
message UpdateCrowdfundRequest {
  string crowdfund_id = 1;
  string title = 2;
  string description = 3;
  string story = 4;
  google.protobuf.Timestamp deadline = 5;
  CrowdfundStatus status = 6;
  string image_url = 7;
  string metadata = 8;
}

message UpdateCrowdfundResponse {
  CrowdfundMessage crowdfund = 1;
}

// Delete Crowdfund
message DeleteCrowdfundRequest {
  string crowdfund_id = 1;
}

message DeleteCrowdfundResponse {
  bool success = 1;
  string message = 2;
}

// Make Donation
message MakeDonationRequest {
  string crowdfund_id = 1;
  uint64 amount = 2;
  string message = 3;
  bool is_anonymous = 4;
  uint64 source_account_id = 5;
}

message MakeDonationResponse {
  CrowdfundDonationMessage donation = 1;
}

// Get Crowdfund Donations
message GetCrowdfundDonationsRequest {
  string crowdfund_id = 1;
  int32 page = 2;
  int32 page_size = 3;
}

message GetCrowdfundDonationsResponse {
  repeated CrowdfundDonationMessage donations = 1;
  DonationPaginationInfo pagination = 2;
}

// Get User Donations
message GetUserDonationsRequest {
  int32 page = 1;
  int32 page_size = 2;
}

message GetUserDonationsResponse {
  repeated CrowdfundDonationMessage donations = 1;
  DonationPaginationInfo pagination = 2;
}

// Generate Receipt
message GenerateDonationReceiptRequest {
  string donation_id = 1;
}

message GenerateDonationReceiptResponse {
  CrowdfundReceiptMessage receipt = 1;
}

// Get User Receipts
message GetUserCrowdfundReceiptsRequest {
  int32 page = 1;
  int32 page_size = 2;
}

message GetUserCrowdfundReceiptsResponse {
  repeated CrowdfundReceiptMessage receipts = 1;
  CrowdfundReceiptPaginationInfo pagination = 2;
}

// Get Crowdfund Statistics
message GetCrowdfundStatisticsRequest {
  string crowdfund_id = 1;
}

message GetCrowdfundStatisticsResponse {
  string crowdfund_id = 1;
  uint64 total_raised = 2;
  uint64 target_amount = 3;
  double progress_percentage = 4;
  int32 donor_count = 5;
  uint64 average_donation = 6;
  uint64 largest_donation = 7;
  int32 days_remaining = 8;
  bool is_completed = 9;
  google.protobuf.Timestamp created_at = 10;
  // Enhanced statistics fields
  int32 unique_donors = 11;
  uint64 smallest_donation = 12;
  repeated ContributorLeaderboardEntry top_contributors = 13;
  repeated DailyProgressEntry daily_progress = 14;
  double funding_velocity = 15;
  string projected_completion_date = 16;
}

// Leaderboard entry for top contributors
message ContributorLeaderboardEntry {
  int32 rank = 1;
  string display_name = 2;
  double total_amount = 3;
  int32 contribution_count = 4;
  bool is_anonymous = 5;
}

// Daily progress tracking
message DailyProgressEntry {
  string date = 1;
  double amount = 2;
  int32 donation_count = 3;
  double cumulative_amount = 4;
}

// Withdraw from Crowdfund (Campaign Creator Only)
message WithdrawFromCrowdfundRequest {
  string crowdfund_id = 1;
  uint64 amount = 2; // Amount in minor units (kobo)
  string transaction_pin = 3;
  // Destination account for withdrawal - one of the following:
  // If destination_account_id is set, funds go to that specific account
  // If destination_account_type is set, funds go to user's account of that type
  // If neither is set, funds go to user's primary account
  string destination_account_id = 4;    // Optional: specific account UUID
  string destination_account_type = 5;  // Optional: "personal", "savings", or "investment"
}

message WithdrawFromCrowdfundResponse {
  string crowdfund_id = 1;
  uint64 amount_withdrawn = 2; // Amount withdrawn in minor units (kobo)
  uint64 remaining_balance = 3; // Remaining campaign balance in minor units
  string destination_account_id = 4; // Account where funds were credited
  uint64 destination_new_balance = 5; // New balance of destination account
  string message = 6;
}

// Get My Crowdfunds (Creator's campaigns)
message GetMyCrowdfundsRequest {
  int32 page = 1;
  int32 page_size = 2;
  string status = 3; // Optional filter: "active", "completed", "cancelled"
}

message GetMyCrowdfundsResponse {
  repeated CrowdfundMessage crowdfunds = 1;
  CrowdfundPaginationInfo pagination = 2;
}

// Get Campaign Wallet Balance
message GetCampaignWalletBalanceRequest {
  string crowdfund_id = 1;
}

message GetCampaignWalletBalanceResponse {
  string crowdfund_id = 1;
  string campaign_wallet_id = 2;
  uint64 balance = 3; // In minor units (kobo)
  uint64 available_balance = 4; // Available for withdrawal
  string currency = 5;
}

// ============================================================================
// PAGINATION INFO
// ============================================================================

message CrowdfundPaginationInfo {
  int32 current_page = 1;
  int32 total_pages = 2;
  int32 total_items = 3;
  int32 items_per_page = 4;
  bool has_next = 5;
  bool has_prev = 6;
}

message DonationPaginationInfo {
  int32 current_page = 1;
  int32 total_pages = 2;
  int32 total_items = 3;
  int32 items_per_page = 4;
  bool has_next = 5;
  bool has_prev = 6;
}

message CrowdfundReceiptPaginationInfo {
  int32 current_page = 1;
  int32 total_pages = 2;
  int32 total_items = 3;
  int32 items_per_page = 4;
  bool has_next = 5;
  bool has_prev = 6;
}

// ============================================================================
// SERVICE DEFINITION
// ============================================================================

service CrowdfundService {
  // Crowdfund Management
  rpc CreateCrowdfund(CreateCrowdfundRequest) returns (CreateCrowdfundResponse) {
    option (google.api.http) = {
      post: "/v1/crowdfunds"
      body: "*"
    };
  }

  rpc GetCrowdfund(GetCrowdfundRequest) returns (GetCrowdfundResponse) {
    option (google.api.http) = {
      get: "/v1/crowdfunds/{crowdfund_id}"
    };
  }

  rpc ListCrowdfunds(ListCrowdfundsRequest) returns (ListCrowdfundsResponse) {
    option (google.api.http) = {
      get: "/v1/crowdfunds"
    };
  }

  rpc SearchCrowdfunds(SearchCrowdfundsRequest) returns (SearchCrowdfundsResponse) {
    option (google.api.http) = {
      get: "/v1/crowdfunds/search"
    };
  }

  rpc UpdateCrowdfund(UpdateCrowdfundRequest) returns (UpdateCrowdfundResponse) {
    option (google.api.http) = {
      put: "/v1/crowdfunds/{crowdfund_id}"
      body: "*"
    };
  }

  rpc DeleteCrowdfund(DeleteCrowdfundRequest) returns (DeleteCrowdfundResponse) {
    option (google.api.http) = {
      delete: "/v1/crowdfunds/{crowdfund_id}"
    };
  }

  // Donation Operations
  rpc MakeDonation(MakeDonationRequest) returns (MakeDonationResponse) {
    option (google.api.http) = {
      post: "/v1/crowdfunds/{crowdfund_id}/donations"
      body: "*"
    };
  }

  rpc GetCrowdfundDonations(GetCrowdfundDonationsRequest) returns (GetCrowdfundDonationsResponse) {
    option (google.api.http) = {
      get: "/v1/crowdfunds/{crowdfund_id}/donations"
    };
  }

  rpc GetUserDonations(GetUserDonationsRequest) returns (GetUserDonationsResponse) {
    option (google.api.http) = {
      get: "/v1/donations"
    };
  }

  // Receipt Operations
  rpc GenerateDonationReceipt(GenerateDonationReceiptRequest) returns (GenerateDonationReceiptResponse) {
    option (google.api.http) = {
      post: "/v1/donations/{donation_id}/receipt"
      body: "*"
    };
  }

  rpc GetUserCrowdfundReceipts(GetUserCrowdfundReceiptsRequest) returns (GetUserCrowdfundReceiptsResponse) {
    option (google.api.http) = {
      get: "/v1/crowdfund-receipts"
    };
  }

  // Statistics
  rpc GetCrowdfundStatistics(GetCrowdfundStatisticsRequest) returns (GetCrowdfundStatisticsResponse) {
    option (google.api.http) = {
      get: "/v1/crowdfunds/{crowdfund_id}/statistics"
    };
  }

  // Withdraw Funds (Campaign Creator Only)
  rpc WithdrawFromCrowdfund(WithdrawFromCrowdfundRequest) returns (WithdrawFromCrowdfundResponse) {
    option (google.api.http) = {
      post: "/v1/crowdfunds/{crowdfund_id}/withdraw"
      body: "*"
    };
  }

  // Get My Crowdfunds (Creator's campaigns)
  rpc GetMyCrowdfunds(GetMyCrowdfundsRequest) returns (GetMyCrowdfundsResponse) {
    option (google.api.http) = {
      get: "/v1/crowdfunds/my"
    };
  }

  // Get Campaign Wallet Balance
  rpc GetCampaignWalletBalance(GetCampaignWalletBalanceRequest) returns (GetCampaignWalletBalanceResponse) {
    option (google.api.http) = {
      get: "/v1/crowdfunds/{crowdfund_id}/wallet-balance"
    };
  }

  // Crowdfund Leaderboard (public, no auth required)
  rpc GetCrowdfundLeaderboard(GetCrowdfundLeaderboardRequest) returns (GetCrowdfundLeaderboardResponse) {
    option (google.api.http) = {
      get: "/v1/crowdfunds/leaderboard"
    };
  }

  // Notification Channel Operations
  rpc ConnectNotificationChannel(ConnectNotificationChannelRequest) returns (ConnectNotificationChannelResponse) {
    option (google.api.http) = {
      post: "/v1/crowdfunds/notification-channels/connect"
      body: "*"
    };
  }

  rpc DisconnectNotificationChannel(DisconnectNotificationChannelRequest) returns (DisconnectNotificationChannelResponse) {
    option (google.api.http) = {
      delete: "/v1/crowdfunds/notification-channels/{channel_id}"
    };
  }

  rpc GetNotificationChannels(GetNotificationChannelsRequest) returns (GetNotificationChannelsResponse) {
    option (google.api.http) = {
      get: "/v1/crowdfunds/{crowdfund_id}/notification-channels"
    };
  }

  rpc UpdateNotificationChannel(UpdateNotificationChannelRequest) returns (UpdateNotificationChannelResponse) {
    option (google.api.http) = {
      put: "/v1/crowdfunds/notification-channels/{channel_id}"
      body: "*"
    };
  }

  rpc TestNotificationChannel(TestNotificationChannelRequest) returns (TestNotificationChannelResponse) {
    option (google.api.http) = {
      post: "/v1/crowdfunds/notification-channels/{channel_id}/test"
      body: "*"
    };
  }

  rpc GetTelegramBotInfo(GetTelegramBotInfoRequest) returns (GetTelegramBotInfoResponse) {
    option (google.api.http) = {
      get: "/v1/crowdfunds/notification-channels/telegram/bot-info"
    };
  }

  rpc VerifyTelegramChannel(VerifyTelegramChannelRequest) returns (VerifyTelegramChannelResponse) {
    option (google.api.http) = {
      post: "/v1/crowdfunds/notification-channels/telegram/verify"
      body: "*"
    };
  }

  rpc GetNotificationHistory(GetNotificationHistoryRequest) returns (GetNotificationHistoryResponse) {
    option (google.api.http) = {
      get: "/v1/crowdfunds/{crowdfund_id}/notification-history"
    };
  }
}

// ============================================================================
// NOTIFICATION CHANNEL ENUMS
// ============================================================================

enum NotificationChannelType {
  NOTIFICATION_CHANNEL_TYPE_UNSPECIFIED = 0;
  NOTIFICATION_CHANNEL_TYPE_TELEGRAM = 1;
  NOTIFICATION_CHANNEL_TYPE_DISCORD = 2;
  NOTIFICATION_CHANNEL_TYPE_WHATSAPP_BUSINESS = 3;
  NOTIFICATION_CHANNEL_TYPE_SLACK = 4;
}

enum NotificationChannelStatus {
  NOTIFICATION_CHANNEL_STATUS_UNSPECIFIED = 0;
  NOTIFICATION_CHANNEL_STATUS_PENDING = 1;
  NOTIFICATION_CHANNEL_STATUS_ACTIVE = 2;
  NOTIFICATION_CHANNEL_STATUS_PAUSED = 3;
  NOTIFICATION_CHANNEL_STATUS_ERROR = 4;
  NOTIFICATION_CHANNEL_STATUS_DISCONNECTED = 5;
}

enum NotificationEventType {
  NOTIFICATION_EVENT_TYPE_UNSPECIFIED = 0;
  NOTIFICATION_EVENT_TYPE_NEW_DONATION = 1;
  NOTIFICATION_EVENT_TYPE_MILESTONE_REACHED = 2;
  NOTIFICATION_EVENT_TYPE_GOAL_REACHED = 3;
  NOTIFICATION_EVENT_TYPE_NEW_CONTRIBUTOR = 4;
  NOTIFICATION_EVENT_TYPE_LARGE_DONATION = 5;
  NOTIFICATION_EVENT_TYPE_DAILY_SUMMARY = 6;
  NOTIFICATION_EVENT_TYPE_CAMPAIGN_ENDING = 7;
  NOTIFICATION_EVENT_TYPE_CAMPAIGN_ENDED = 8;
  NOTIFICATION_EVENT_TYPE_WITHDRAWAL = 9;
}

// ============================================================================
// NOTIFICATION CHANNEL MESSAGES
// ============================================================================

message NotificationChannelMessage {
  string id = 1;
  string crowdfund_id = 2;
  string creator_user_id = 3;
  NotificationChannelType channel_type = 4;
  NotificationChannelStatus status = 5;
  string channel_name = 6;
  string channel_username = 7;
  repeated NotificationEventType enabled_events = 8;
  NotificationPreferencesMessage preferences = 9;
  string last_notification_at = 10;
  int32 notification_count = 11;
  int32 failure_count = 12;
  string last_error = 13;
  string created_at = 14;
  string updated_at = 15;
}

message NotificationPreferencesMessage {
  bool include_donor_name = 1;
  bool include_amount = 2;
  bool include_message = 3;
  bool include_progress = 4;
  bool include_leaderboard = 5;
  double large_donation_threshold = 6;
  string message_template = 7;
  string language = 8;
  bool quiet_hours_enabled = 9;
  string quiet_hours_start = 10;
  string quiet_hours_end = 11;
  string timezone = 12;
}

message NotificationDeliveryMessage {
  string id = 1;
  string channel_id = 2;
  string crowdfund_id = 3;
  NotificationEventType event_type = 4;
  string event_data = 5;
  string message_content = 6;
  bool success = 7;
  string error_message = 8;
  int32 retry_count = 9;
  string platform_message_id = 10;
  string created_at = 11;
  string delivered_at = 12;
}

// ============================================================================
// NOTIFICATION CHANNEL REQUESTS/RESPONSES
// ============================================================================

message TelegramConnectionDataMessage {
  string chat_id = 1;
  string verification_code = 2;
}

message DiscordConnectionDataMessage {
  string webhook_url = 1;
  string server_name = 2;
  string channel_name = 3;
}

message WhatsAppBusinessConnectionDataMessage {
  string phone_number_id = 1;
  string access_token = 2;
  string recipient_id = 3;
}

message SlackConnectionDataMessage {
  string webhook_url = 1;
  string workspace_name = 2;
  string channel_name = 3;
}

message ConnectNotificationChannelRequest {
  string crowdfund_id = 1;
  NotificationChannelType channel_type = 2;
  string channel_name = 3;
  oneof connection_data {
    TelegramConnectionDataMessage telegram = 4;
    DiscordConnectionDataMessage discord = 5;
    WhatsAppBusinessConnectionDataMessage whatsapp_business = 6;
    SlackConnectionDataMessage slack = 7;
  }
  repeated NotificationEventType enabled_events = 8;
  NotificationPreferencesMessage preferences = 9;
}

message ConnectNotificationChannelResponse {
  NotificationChannelMessage channel = 1;
  bool requires_verification = 2;
  string verification_instructions = 3;
  string message = 4;
}

message DisconnectNotificationChannelRequest {
  string channel_id = 1;
}

message DisconnectNotificationChannelResponse {
  bool success = 1;
  string message = 2;
}

message GetNotificationChannelsRequest {
  string crowdfund_id = 1;
}

message GetNotificationChannelsResponse {
  repeated NotificationChannelMessage channels = 1;
}

message UpdateNotificationChannelRequest {
  string channel_id = 1;
  string channel_name = 2;
  repeated NotificationEventType enabled_events = 3;
  NotificationPreferencesMessage preferences = 4;
  NotificationChannelStatus status = 5;
}

message UpdateNotificationChannelResponse {
  NotificationChannelMessage channel = 1;
  string message = 2;
}

message TestNotificationChannelRequest {
  string channel_id = 1;
}

message TestNotificationChannelResponse {
  bool success = 1;
  string message = 2;
  string platform_message_id = 3;
}

message GetTelegramBotInfoRequest {}

message GetTelegramBotInfoResponse {
  string bot_username = 1;
  string bot_name = 2;
  string bot_link = 3;
  string instructions = 4;
}

message VerifyTelegramChannelRequest {
  string crowdfund_id = 1;
  string chat_id = 2;
  string verification_code = 3;
}

message VerifyTelegramChannelResponse {
  bool success = 1;
  NotificationChannelMessage channel = 2;
  string message = 3;
}

message GetNotificationHistoryRequest {
  string crowdfund_id = 1;
  string channel_id = 2;
  int32 page = 3;
  int32 page_size = 4;
}

message GetNotificationHistoryResponse {
  repeated NotificationDeliveryMessage deliveries = 1;
  int32 total = 2;
  int32 page = 3;
  int32 page_size = 4;
  bool has_more = 5;
}

// ============================================================================
// LEADERBOARD
// ============================================================================

enum LeaderboardSortBy {
  LEADERBOARD_SORT_UNSPECIFIED = 0;
  LEADERBOARD_SORT_MOST_FUNDED = 1;
  LEADERBOARD_SORT_MOST_DONORS = 2;
  LEADERBOARD_SORT_TRENDING = 3;
  LEADERBOARD_SORT_NEARLY_COMPLETE = 4;
  LEADERBOARD_SORT_NEWEST = 5;
}

message GetCrowdfundLeaderboardRequest {
  LeaderboardSortBy sort_by = 1;
  string category = 2;
  int32 limit = 3;
  int32 offset = 4;
}

message GetCrowdfundLeaderboardResponse {
  repeated LeaderboardCrowdfundEntry entries = 1;
  int32 total_count = 2;
}

message LeaderboardCrowdfundEntry {
  int32 rank = 1;
  CrowdfundMessage crowdfund = 2;
}
