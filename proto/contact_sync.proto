syntax = "proto3";

package lazervault.contact;

import "google/protobuf/timestamp.proto";
import "google/api/annotations.proto";

option go_package = "github.com/lazervault/backend/gen/go/contact";

// ContactSyncService handles syncing device contacts with the backend
// and converting them to recipients
service ContactSyncService {
  // Syncs multiple contacts from device to backend
  rpc SyncContacts(SyncContactsRequest) returns (SyncContactsResponse) {
    option (google.api.http) = {
      post: "/v1/contacts/sync"
      body: "*"
    };
  }

  // Gets all synced contacts for the authenticated user
  rpc GetSyncedContacts(GetSyncedContactsRequest) returns (GetSyncedContactsResponse) {
    option (google.api.http) = {
      get: "/v1/contacts/synced"
    };
  }

  // Deletes synced contacts from backend
  rpc DeleteSyncedContacts(DeleteSyncedContactsRequest) returns (DeleteSyncedContactsResponse) {
    option (google.api.http) = {
      delete: "/v1/contacts/synced"
    };
  }

  // Converts a device contact to a saved recipient
  rpc ConvertContactToRecipient(ConvertContactToRecipientRequest) returns (ConvertContactToRecipientResponse) {
    option (google.api.http) = {
      post: "/v1/contacts/convert-to-recipient"
      body: "*"
    };
  }

  // Finds LazerVault users from synced contacts
  // This matches phone numbers/emails with registered users
  rpc FindLazerVaultUsers(FindLazerVaultUsersRequest) returns (FindLazerVaultUsersResponse) {
    option (google.api.http) = {
      post: "/v1/contacts/find-users"
      body: "*"
    };
  }

  // Updates contact sync preferences
  rpc UpdateSyncPreferences(UpdateSyncPreferencesRequest) returns (UpdateSyncPreferencesResponse) {
    option (google.api.http) = {
      patch: "/v1/contacts/sync-preferences"
      body: "*"
    };
  }
}

// SyncedContact represents a contact synced to the backend
message SyncedContact {
  string id = 1;                                    // Unique contact ID
  string user_id = 2;                               // Owner user ID
  string name = 3;                                  // Contact display name
  repeated string phone_numbers = 4;                // Phone numbers
  repeated string emails = 5;                       // Email addresses
  string photo_url = 6;                             // Profile photo URL
  google.protobuf.Timestamp created_at = 7;         // When contact was synced
  google.protobuf.Timestamp updated_at = 8;         // Last update time
  string device_contact_id = 9;                     // Original device contact ID
  bool is_lazervault_user = 10;                     // Whether this contact is a LazerVault user
  string lazervault_user_id = 11;                   // LazerVault user ID if registered
  string lazervault_username = 12;                  // LazerVault @username if registered
}

// Request to sync contacts
message SyncContactsRequest {
  repeated ContactToSync contacts = 1;
  bool replace_all = 2;                             // If true, replace all existing synced contacts
}

// Individual contact to sync
message ContactToSync {
  string device_contact_id = 1;                     // Device-specific contact ID
  string name = 2;                                  // Display name
  repeated string phone_numbers = 3;                // Phone numbers
  repeated string emails = 4;                       // Email addresses
}

// Response to sync contacts
message SyncContactsResponse {
  repeated SyncedContact synced_contacts = 1;
  int32 total_synced = 2;
  int32 total_matched_users = 3;                    // Number of contacts matched to LazerVault users
  repeated LazerVaultUserMatch matched_users = 4;   // Matched LazerVault users
}

// Matched LazerVault user from contacts
message LazerVaultUserMatch {
  string contact_id = 1;                            // Synced contact ID
  string user_id = 2;                               // LazerVault user ID
  string username = 3;                              // LazerVault @username
  string name = 4;                                  // User's name
  string profile_photo_url = 5;                     // Profile photo
  bool is_verified = 6;                             // Verification status
  string matched_by = 7;                            // What matched: "phone" or "email"
}

// Request to get synced contacts
message GetSyncedContactsRequest {
  int32 page = 1;
  int32 page_size = 2;
  string search_query = 3;                          // Search by name, phone, email
  bool only_lazervault_users = 4;                   // Filter to only contacts who are LazerVault users
}

// Response with synced contacts
message GetSyncedContactsResponse {
  repeated SyncedContact contacts = 1;
  int32 total_count = 2;
  int32 page = 3;
  int32 page_size = 4;
}

// Request to delete synced contacts
message DeleteSyncedContactsRequest {
  repeated string contact_ids = 1;                  // Specific contact IDs to delete (empty = delete all)
  bool delete_all = 2;                              // If true, delete all synced contacts
}

// Response to delete synced contacts
message DeleteSyncedContactsResponse {
  int32 deleted_count = 1;
  bool success = 2;
}

// Request to convert contact to recipient
message ConvertContactToRecipientRequest {
  string contact_id = 1;                            // Synced contact ID (if synced)
  string device_contact_id = 2;                     // Or device contact ID (if not synced)
  string name = 3;                                  // Contact name
  string phone_number = 4;                          // Selected phone number
  string email = 5;                                 // Selected email
  string account_number = 6;                        // Bank account number (if known)
  string bank_name = 7;                             // Bank name (if known)
  string sort_code = 8;                             // Sort code (if known)
  bool auto_detect_lazervault = 9;                  // Try to detect if this is a LazerVault user
}

// Response to convert contact to recipient
message ConvertContactToRecipientResponse {
  string recipient_id = 1;
  bool is_lazervault_user = 2;
  string lazervault_user_id = 3;
  string lazervault_username = 4;
  RecipientDetails recipient = 5;
}

// Recipient details
message RecipientDetails {
  string id = 1;
  string name = 2;
  string account_number = 3;
  string bank_name = 4;
  string sort_code = 5;
  string profile_photo_url = 6;
  bool is_favorite = 7;
}

// Request to find LazerVault users
message FindLazerVaultUsersRequest {
  repeated string phone_numbers = 1;
  repeated string emails = 2;
}

// Response with found LazerVault users
message FindLazerVaultUsersResponse {
  repeated LazerVaultUserMatch matched_users = 1;
  int32 total_matches = 2;
}

// Request to update sync preferences
message UpdateSyncPreferencesRequest {
  bool auto_sync_enabled = 1;
  SyncFrequency sync_frequency = 2;
  bool match_with_users = 3;                        // Auto-match contacts with LazerVault users
  bool sync_photos = 4;                             // Include contact photos in sync
}

// Sync frequency options
enum SyncFrequency {
  SYNC_FREQUENCY_UNSPECIFIED = 0;
  MANUAL = 1;                                       // Manual sync only
  DAILY = 2;                                        // Sync daily
  WEEKLY = 3;                                       // Sync weekly
  REAL_TIME = 4;                                    // Sync on contact changes
}

// Response to update sync preferences
message UpdateSyncPreferencesResponse {
  SyncPreferences preferences = 1;
  bool success = 2;
}

// Sync preferences
message SyncPreferences {
  string user_id = 1;
  bool auto_sync_enabled = 2;
  SyncFrequency sync_frequency = 3;
  bool match_with_users = 4;
  bool sync_photos = 5;
  google.protobuf.Timestamp last_sync_at = 6;
  int32 total_synced_contacts = 7;
  int32 total_matched_users = 8;
}
