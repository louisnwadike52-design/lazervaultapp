syntax = "proto3";

package payments;

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "protoc-gen-openapiv2/options/annotations.proto";

option go_package = "core-payments-service/proto";

// OpenAPI v2 documentation
option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = {
  info: {
    title: "LazerVault Payments Service";
    version: "1.0";
    description: "Core payment and transfer operations service for LazerVault";
  };
  schemes: HTTP;
  schemes: HTTPS;
  consumes: "application/json";
  produces: "application/json";
  security_definitions: {
    security: {
      key: "bearer";
      value: {
        type: TYPE_API_KEY;
        in: IN_HEADER;
        name: "Authorization";
        description: "Bearer token authentication";
      }
    }
  };
};

// Payments Service - All payment and transfer operations
service PaymentsService {
  // === MONEY TRANSFER OPERATIONS ===

  // Transfer funds to another account (sendFunds from AppServiceName)
  rpc SendFunds(SendFundsRequest) returns (SendFundsResponse) {
    option (google.api.http) = {
      post: "/api/v1/payments/transfer"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Send Funds";
      description: "Transfer funds to another account";
      tags: ["Payments"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  // Batch transfer to multiple recipients (batchTransfer from AppServiceName)
  rpc BatchTransfer(BatchTransferRequest) returns (BatchTransferResponse) {
    option (google.api.http) = {
      post: "/api/v1/payments/batch-transfer"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Batch Transfer";
      description: "Transfer funds to multiple recipients";
      tags: ["Payments"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  // Withdraw cash from account
  rpc Withdraw(WithdrawRequest) returns (WithdrawResponse) {
    option (google.api.http) = {
      post: "/api/v1/payments/withdraw"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Withdraw";
      description: "Withdraw cash from account";
      tags: ["Payments"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  // Deposit cash to account
  rpc Deposit(DepositRequest) returns (DepositResponse) {
    option (google.api.http) = {
      post: "/api/v1/payments/deposit"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Deposit";
      description: "Deposit cash to account";
      tags: ["Payments"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  // === PAYMENT OPERATIONS ===

  // Pay using tag/username (tagPay from AppServiceName)
  rpc PayWithTag(PayWithTagRequest) returns (PayWithTagResponse) {
    option (google.api.http) = {
      post: "/api/v1/payments/tag-pay"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Pay With Tag";
      description: "Pay using tag/username";
      tags: ["Payments"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  // Pay electricity bill (payElectricityBill from AppServiceName)
  rpc PayElectricityBill(PayElectricityBillRequest) returns (PayElectricityBillResponse) {
    option (google.api.http) = {
      post: "/api/v1/payments/electricity"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Pay Electricity Bill";
      description: "Pay electricity bill";
      tags: ["Bills"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  // Buy airtime/data (airtime from AppServiceName)
  rpc BuyAirtime(BuyAirtimeRequest) returns (BuyAirtimeResponse) {
    option (google.api.http) = {
      post: "/api/v1/payments/airtime"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Buy Airtime";
      description: "Purchase airtime/data";
      tags: ["Bills"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  // Pay by scanning barcode (barcodeQuickPay from AppServiceName)
  rpc BarcodePay(BarcodePayRequest) returns (BarcodePayResponse) {
    option (google.api.http) = {
      post: "/api/v1/payments/barcode"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Barcode Pay";
      description: "Pay by scanning barcode";
      tags: ["Payments"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  // AI-powered scan to pay (aiScanToPay from AppServiceName)
  rpc ScanToPay(ScanToPayRequest) returns (ScanToPayResponse) {
    option (google.api.http) = {
      post: "/api/v1/payments/scan"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Scan To Pay";
      description: "AI-powered scan to pay";
      tags: ["Payments"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  // === UTILITY OPERATIONS ===

  // Get payment history
  rpc GetPaymentHistory(GetPaymentHistoryRequest) returns (GetPaymentHistoryResponse) {
    option (google.api.http) = {
      get: "/api/v1/payments/history"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get Payment History";
      description: "Get payment history for user";
      tags: ["Payments"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  // Get bill providers
  rpc GetBillProviders(GetBillProvidersRequest) returns (GetBillProvidersResponse) {
    option (google.api.http) = {
      get: "/api/v1/payments/providers/bills"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get Bill Providers";
      description: "Get list of bill providers";
      tags: ["Bills"];
    };
  }

  // Get airtime providers
  rpc GetAirtimeProviders(GetAirtimeProvidersRequest) returns (GetAirtimeProvidersResponse) {
    option (google.api.http) = {
      get: "/api/v1/payments/providers/airtime"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get Airtime Providers";
      description: "Get list of airtime providers";
      tags: ["Bills"];
    };
  }

  // Pay using scanned bank details (scan-to-pay feature)
  rpc PayWithBankDetails(PayWithBankDetailsRequest) returns (PayWithBankDetailsResponse) {
    option (google.api.http) = {
      post: "/api/v1/payments/bank-details"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Pay With Bank Details";
      description: "Pay using scanned bank account details (internal or external transfer)";
      tags: ["Payments"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  // Resolve tag to account
  rpc ResolveTag(ResolveTagRequest) returns (ResolveTagResponse) {
    option (google.api.http) = {
      get: "/api/v1/payments/resolve/{tag}"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Resolve Tag";
      description: "Resolve tag/username to account";
      tags: ["Payments"];
    };
  }

  // Verify bank account details (Lemfi-style verification)
  rpc VerifyBankAccount(VerifyBankAccountRequest) returns (VerifyBankAccountResponse) {
    option (google.api.http) = {
      post: "/api/v1/recipients/verify-account"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Verify Bank Account";
      description: "Verify bank account and retrieve account holder name using Paystack";
      tags: ["Recipients"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  // === TRANSFER OPERATIONS (Consolidated from Banking Service) ===

  rpc InitiateDomesticTransfer(InitiateDomesticTransferRequest) returns (InitiateTransferResponse) {
    option (google.api.http) = {
      post: "/api/v1/transfers/domestic"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Initiate Domestic Transfer";
      description: "Initiate a domestic bank transfer";
      tags: ["Transfers"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  rpc InitiateInternalTransfer(InitiateInternalTransferRequest) returns (InitiateTransferResponse) {
    option (google.api.http) = {
      post: "/api/v1/transfers/internal"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Initiate Internal Transfer";
      description: "Transfer funds between LazerVault accounts";
      tags: ["Transfers"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  rpc InitiateInternationalTransfer(InitiateInternationalTransferRequest) returns (InitiateTransferResponse) {
    option (google.api.http) = {
      post: "/api/v1/transfers/international"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Initiate International Transfer";
      description: "Initiate an international money transfer";
      tags: ["Transfers"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  rpc InitiateUserTransfer(InitiateUserTransferRequest) returns (InitiateTransferResponse) {
    option (google.api.http) = {
      post: "/api/v1/transfers/user"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Transfer to User";
      description: "Transfer funds to a LazerVault user by userId";
      tags: ["Transfers"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  rpc InitiatePhoneTransfer(InitiatePhoneTransferRequest) returns (InitiateTransferResponse) {
    option (google.api.http) = {
      post: "/api/v1/transfers/phone"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Transfer by Phone";
      description: "Transfer funds to a user by phone number";
      tags: ["Transfers"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  rpc GetTransferStatus(GetTransferStatusRequest) returns (GetTransferStatusResponse) {
    option (google.api.http) = {
      get: "/api/v1/transfers/{reference}"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get Transfer Status";
      description: "Get the status of a transfer by reference";
      tags: ["Transfers"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  rpc GetUserTransfers(GetUserTransfersRequest) returns (GetUserTransfersResponse) {
    option (google.api.http) = {
      get: "/api/v1/transfers"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get User Transfers";
      description: "Get transfer history for the authenticated user";
      tags: ["Transfers"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  rpc GetTransferFee(GetTransferFeeRequest) returns (GetTransferFeeResponse) {
    // GetTransferFee already has its messages defined in the existing proto
  }

  rpc GetDailyUsage(GetDailyUsageRequest) returns (GetDailyUsageResponse) {
    option (google.api.http) = {
      get: "/api/v1/transfers/daily-usage"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get Daily Usage";
      description: "Get daily transfer usage and remaining limits";
      tags: ["Transfers"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  rpc GetExchangeRate(GetExchangeRateRequest) returns (GetExchangeRateResponse) {
    option (google.api.http) = {
      get: "/api/v1/transfers/exchange-rate"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get Exchange Rate";
      description: "Get exchange rate for international transfers";
      tags: ["Transfers"];
    };
  }

  rpc HandleTransferWebhook(HandleTransferWebhookRequest) returns (HandleTransferWebhookResponse) {
    option (google.api.http) = {
      post: "/api/v1/webhooks/transfer"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Handle Transfer Webhook";
      description: "Process provider webhook for transfer status updates";
      tags: ["Webhooks"];
    };
  }

  // === PLATFORM FEE OPERATIONS ===

  // PayPlatformFee - Debit user account, credit platform revenue wallet
  rpc PayPlatformFee(PayPlatformFeeRequest) returns (PayPlatformFeeResponse) {
    option (google.api.http) = {
      post: "/api/v1/payments/platform-fee"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Pay Platform Fee";
      description: "Debit user and credit platform revenue wallet. Service-to-service only.";
      tags: ["Platform"];
    };
  }

  // RefundFromPlatformWallet - Refund from platform wallet to user account
  rpc RefundFromPlatformWallet(RefundFromPlatformWalletRequest) returns (RefundFromPlatformWalletResponse) {
    option (google.api.http) = {
      post: "/api/v1/payments/platform-refund"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Refund From Platform Wallet";
      description: "Refund from platform wallet to user account. Service-to-service only.";
      tags: ["Platform"];
    };
  }

  // === QR PAYMENT TOKEN OPERATIONS ===

  // Generate a QR payment token for receiving payments
  rpc GenerateQRPaymentToken(GenerateQRTokenRequest) returns (GenerateQRTokenResponse) {
    option (google.api.http) = {
      post: "/api/v1/payments/qr/generate"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Generate QR Payment Token";
      description: "Generate an HMAC-signed QR token for receiving payments";
      tags: ["QR Payments"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  // Validate a QR payment token before initiating transfer
  rpc ValidateQRPaymentToken(ValidateQRTokenRequest) returns (ValidateQRTokenResponse) {
    option (google.api.http) = {
      post: "/api/v1/payments/qr/validate"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Validate QR Payment Token";
      description: "Validate and decode a QR payment token";
      tags: ["QR Payments"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  // === BATCH TRANSFER HISTORY ===

  // Get paginated list of user's batch transfers
  rpc GetBatchTransfers(GetBatchTransfersRequest) returns (GetBatchTransfersResponse) {
    option (google.api.http) = {
      get: "/api/v1/payments/batch-transfers"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get Batch Transfers";
      description: "Get paginated list of batch transfers for the authenticated user";
      tags: ["Payments"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }

  // Get detail of a specific batch transfer
  rpc GetBatchTransferDetail(GetBatchTransferDetailRequest) returns (GetBatchTransferDetailResponse) {
    option (google.api.http) = {
      get: "/api/v1/payments/batch-transfers/{batch_id}"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get Batch Transfer Detail";
      description: "Get detailed information about a specific batch transfer";
      tags: ["Payments"];
      security: { security_requirement: { key: "bearer"; } };
    };
  }
}

// ===== MODELS =====

message Payment {
  string id = 1;
  string user_id = 2;
  string account_id = 3;
  string payment_type = 4;              // "transfer", "withdraw", "deposit", "bill", "airtime"
  string reference = 5;
  double amount = 6;
  string currency = 7;
  string status = 8;                    // "pending", "completed", "failed", "reversed"
  string recipient = 9;                 // Account number, tag, or provider
  string description = 10;
  string metadata = 11;                 // JSON metadata
  string created_at = 12;
  string updated_at = 13;
}

message BillProvider {
  string id = 1;
  string name = 2;
  string type = 3;                      // "electricity", "water", "internet", "cable"
  string logo_url = 4;
  bool is_active = 5;
  double min_amount = 6;
  double max_amount = 7;
}

message AirtimeProvider {
  string id = 1;
  string name = 2;
  string network = 3;                   // "MTN", "Airtel", "Glo", "9mobile"
  string logo_url = 4;
  bool is_active = 5;
  repeated string denominations = 6;    // ["100", "200", "500", "1000"]
}

// ===== SEND FUNDS (Transfer) =====
// NOTE: user_id extracted from JWT token, not from request
message SendFundsRequest {
  string from_account_id = 1;
  string to_account_number = 2;
  double amount = 3;
  string description = 4;

  // Transaction PIN verification (replaces direct PIN field)
  string transaction_id = 5;           // Unique transaction identifier
  string verification_token = 6;        // Token from TransactionPinService validation

  // External transfer fields
  string destination_bank_code = 7;    // Bank code for external transfers (e.g., Flutterwave bank code)
  string beneficiary_name = 8;         // Recipient name for external transfers

}

message SendFundsResponse {
  Payment payment = 1;
  double new_balance = 2;
  string recipient_name = 3;
  string message = 4;
}

// ===== BATCH TRANSFER =====

message BatchTransferItem {
  string to_account_number = 1;
  double amount = 2;
  string description = 3;
  string reference = 4;
  string category = 5;
  string destination_bank_code = 6;   // Bank code for external transfers (empty = internal)
  string beneficiary_name = 7;        // Verified beneficiary name
  string destination_bank_name = 8;   // Human-readable bank name
}

// NOTE: user_id extracted from JWT token, not from request
message BatchTransferRequest {
  string from_account_id = 1;
  repeated BatchTransferItem transfers = 2;

  // Transaction PIN verification (replaces direct PIN field)
  string transaction_id = 3;           // Unique transaction identifier
  string verification_token = 4;        // Token from TransactionPinService validation
}

message BatchTransferResponse {
  string batch_id = 1;
  int32 total_transfers = 2;
  int32 successful_transfers = 3;
  int32 failed_transfers = 4;
  repeated BatchTransferResultItem results = 5;
  double new_balance = 6;
  string message = 7;
  string status = 8;
  double total_amount = 9;
  double total_fee = 10;
  string created_at = 11;
  string completed_at = 12;
}

message BatchTransferResultItem {
  string transfer_id = 1;
  string status = 2;
  double amount = 3;
  double fee = 4;
  string recipient_name = 5;
  string recipient_account = 6;
  string failure_reason = 7;
  string reference = 8;
  string destination_bank_code = 9;   // Bank code (populated for external)
  string destination_bank_name = 10;  // Bank name (populated for external)
  string transfer_type = 11;          // "internal" or "external"
  string beneficiary_name = 12;       // Verified beneficiary name
}

// ===== WITHDRAW =====
// NOTE: user_id extracted from JWT token, not from request
message WithdrawRequest {
  string account_id = 1;
  double amount = 2;
  string description = 3;
  string location = 4;                  // ATM location or branch

  // Transaction PIN verification (replaces direct PIN field)
  string transaction_id = 5;           // Unique transaction identifier
  string verification_token = 6;        // Token from TransactionPinService validation
}

message WithdrawResponse {
  Payment payment = 1;
  double new_balance = 2;
  double available_balance = 3;
  string message = 4;
}

// ===== DEPOSIT =====
// NOTE: user_id extracted from JWT token, not from request
message DepositRequest {
  string account_id = 1;
  double amount = 2;
  string description = 3;
  string location = 4;                  // Deposit location or branch
  string deposit_type = 5;              // "cash", "check", "transfer"
}

message DepositResponse {
  Payment payment = 1;
  double new_balance = 2;
  double available_balance = 3;
  string message = 4;
}

// ===== TAG PAY =====
// NOTE: user_id extracted from JWT token, not from request
message PayWithTagRequest {
  string from_account_id = 1;
  string recipient_tag = 2;             // @username or tag
  double amount = 3;
  string description = 4;

  // Transaction PIN verification (replaces direct PIN field)
  string transaction_id = 5;           // Unique transaction identifier
  string verification_token = 6;        // Token from TransactionPinService validation
}

message PayWithTagResponse {
  Payment payment = 1;
  double new_balance = 2;
  string recipient_name = 3;
  string recipient_account = 4;
  string message = 5;
}

// ===== ELECTRICITY BILL =====
// NOTE: user_id extracted from JWT token, not from request
message PayElectricityBillRequest {
  string account_id = 1;
  string provider_id = 2;
  string meter_number = 3;
  double amount = 4;
  string meter_type = 5;                // "prepaid", "postpaid"

  // Transaction PIN verification (replaces direct PIN field)
  string transaction_id = 6;           // Unique transaction identifier
  string verification_token = 7;        // Token from TransactionPinService validation
}

message PayElectricityBillResponse {
  Payment payment = 1;
  double new_balance = 2;
  string token = 3;                     // Electricity token (for prepaid)
  string units = 4;                     // Units purchased
  string message = 5;
}

// ===== AIRTIME =====
// NOTE: user_id extracted from JWT token, not from request
message BuyAirtimeRequest {
  string account_id = 1;
  string provider_id = 2;
  string phone_number = 3;
  double amount = 4;
  string airtime_type = 5;              // "airtime", "data"

  // Transaction PIN verification (replaces direct PIN field)
  string transaction_id = 6;           // Unique transaction identifier
  string verification_token = 7;        // Token from TransactionPinService validation
}

message BuyAirtimeResponse {
  Payment payment = 1;
  double new_balance = 2;
  string phone_number = 3;
  string message = 4;
}

// ===== BARCODE PAY =====
// NOTE: user_id extracted from JWT token, not from request
message BarcodePayRequest {
  string account_id = 1;
  string barcode_data = 2;              // Scanned barcode data
  double amount = 3;

  // Transaction PIN verification (replaces direct PIN field)
  string transaction_id = 4;           // Unique transaction identifier
  string verification_token = 5;        // Token from TransactionPinService validation
}

message BarcodePayResponse {
  Payment payment = 1;
  double new_balance = 2;
  string merchant_name = 3;
  string message = 4;
}

// ===== SCAN TO PAY (AI) =====
// NOTE: user_id extracted from JWT token, not from request
message ScanToPayRequest {
  string account_id = 1;
  bytes image_data = 2;                 // Scanned receipt/bill image
  double amount = 3;                    // Optional: can be extracted from image

  // Transaction PIN verification (replaces direct PIN field)
  string transaction_id = 4;           // Unique transaction identifier
  string verification_token = 5;        // Token from TransactionPinService validation
}

message ScanToPayResponse {
  Payment payment = 1;
  double new_balance = 2;
  string merchant_name = 3;
  double extracted_amount = 4;          // Amount extracted by AI
  string bill_details = 5;              // JSON of extracted details
  string message = 6;
}

// ===== PAYMENT HISTORY =====
// NOTE: user_id extracted from JWT token, not from request
message GetPaymentHistoryRequest {
  string account_id = 1;                // Optional filter
  string payment_type = 2;              // Optional filter
  string status = 3;                    // Optional filter
  string start_date = 4;
  string end_date = 5;
  int32 limit = 6;
  int32 offset = 7;
}

// TransactionItem represents a unified transaction that can be either a Payment or a Transfer
// This allows the payment history endpoint to return both types in a single response
message TransactionItem {
  string id = 1;                          // UUID of the transaction (Payment or Transfer ID)
  string type = 2;                        // "payment" or "transfer" - distinguishes the source table
  string user_id = 3;                      // User who initiated the transaction
  int64 created_at = 4;                   // Unix timestamp of creation
  string amount = 5;                      // Amount as string (preserves decimal precision)
  string currency = 6;                    // Currency code (NGN, USD, etc.)
  string status = 7;                       // Transaction status
  string description = 8;                   // Transaction description/narration
  string reference = 9;                     // Transaction reference
  double fee = 10;                         // Transaction fee (0 for internal transfers)
  string total_amount = 11;                 // Total amount including fee

  // Source information (where funds came from)
  string source_account_id = 12;           // For payments: account_id, for transfers: source_account_id
  string source_account_number = 13;        // Virtual account number (for display)

  // Destination information (where funds went to)
  string destination_account_id = 14;         // For internal transfers: destination account ID
  string destination_account_number = 15;       // Virtual account number (for display)
  string destination_name = 16;               // For external transfers: bank account name
  string destination_bank_code = 17;           // For external transfers: bank code
  string destination_bank_name = 18;           // For external transfers: bank name

  // Metadata
  string payment_type = 19;                 // For payments: payment_type (transfer, withdraw, deposit, etc.)
  string transfer_type = 20;                // For transfers: transfer_type (domestic, international)
  string metadata = 21;                     // Additional metadata as JSON string

  // Timestamps
  int64 completed_at = 22;                 // Unix timestamp (optional, for completed transactions)
  int64 failed_at = 23;                     // Unix timestamp (optional, for failed transactions)
}

message GetPaymentHistoryResponse {
  repeated TransactionItem transactions = 1;
  int32 total = 2;
}

// ===== BILL PROVIDERS =====

message GetBillProvidersRequest {
  string type = 1;                      // Optional filter: "electricity", "water", etc.
  bool active_only = 2;
}

message GetBillProvidersResponse {
  repeated BillProvider providers = 1;
  int32 total = 2;
}

// ===== AIRTIME PROVIDERS =====

message GetAirtimeProvidersRequest {
  bool active_only = 1;
}

message GetAirtimeProvidersResponse {
  repeated AirtimeProvider providers = 1;
  int32 total = 2;
}

// ===== RESOLVE TAG =====

message ResolveTagRequest {
  string tag = 1;                       // @username or tag
}

message ResolveTagResponse {
  string account_number = 1;
  string account_name = 2;
  string tag = 3;
  bool is_valid = 4;
}

// ===== PAY WITH BANK DETAILS (Scan-to-Pay) =====

message BankDetails {
  string account_number = 1;
  string account_name = 2;
  string bank_name = 3;
  string bank_code = 4;                // Nigerian bank code (for display purposes)
  string routing_number = 5;           // US routing number (optional)
  string account_type = 6;             // "internal" or "external"
  double confidence_score = 7;         // OCR confidence (0-1)
  string mono_account_id = 8;          // Mono account ID (required for external transfers via Mono)
  double balance = 9;                  // Account balance (from Mono, optional)
}

// NOTE: user_id extracted from JWT token, not from request
message PayWithBankDetailsRequest {
  string from_account_id = 1;
  BankDetails bank_details = 2;
  double amount = 3;
  string currency = 4;
  string description = 5;

  // Transaction PIN verification
  string transaction_id = 6;           // Unique transaction identifier (idempotency key)
  string verification_token = 7;        // Token from TransactionPinService validation
}

message PayWithBankDetailsResponse {
  Payment payment = 1;
  double new_balance = 2;
  string recipient_name = 3;
  string transfer_reference = 4;       // Paystack transfer reference (for external)
  string message = 5;
}

// ===== VERIFY BANK ACCOUNT (Lemfi-style) =====

message VerifyBankAccountRequest {
  string bank_code = 1;                // Nigerian bank code (e.g., "044" for Access Bank)
  string account_number = 2;           // 10-digit account number
  string country = 3;                  // Country code (default: "NG")
}

message VerifyBankAccountResponse {
  bool success = 1;
  string account_number = 2;
  string account_name = 3;             // Account holder name from Paystack
  string bank_name = 4;                // Bank name
  string bank_code = 5;                // Bank code
  string verification_status = 6;      // "verified", "unverified", "pending"
  string error_code = 7;               // Error code if verification failed
  string error_message = 8;            // Error message if verification failed
  string user_message = 9;             // User-friendly error message
}

// ===== TRANSFER CONSOLIDATION MESSAGES =====

message InitiateDomesticTransferRequest {
  string source_account_id = 1;
  int64 amount = 2;
  string currency = 3;
  string destination_account = 4;
  string destination_bank_code = 5;
  string destination_name = 6;
  string narration = 7;
  string reference = 8;
  string idempotency_key = 9;
  string verification_token = 10;
  string transaction_id = 11;
}

message InitiateInternalTransferRequest {
  string from_account_id = 1;
  string to_account_id = 2;
  string to_username = 3;
  int64 amount = 4;
  string currency = 5;
  string narration = 6;
  string reference = 7;
  string idempotency_key = 8;
  string verification_token = 9;
  string transaction_id = 10;
  RecipientInfo recipient_info = 11;
}

message RecipientInfo {
  string name = 1;
  string recipient_type = 2;
  string recipient_source = 3;
  string username = 4;
  string user_id = 5;
  string account_number = 6;
  string bank_code = 7;
  string bank_name = 8;
  string phone_number = 9;
}

message InitiateInternationalTransferRequest {
  string source_account_id = 1;
  int64 amount = 2;
  string source_currency = 3;
  string destination_currency = 4;
  string destination_country = 5;
  string recipient_type = 6;
  map<string, string> recipient_details = 7;
  string narration = 8;
  string reference = 9;
  string idempotency_key = 10;
  string verification_token = 11;
  string transaction_id = 12;
}

// InitiateUserTransferRequest initiates a transfer to a LazerVault user
// Uses userId (UUID) as the stable identifier for the recipient
message InitiateUserTransferRequest {
  string recipient = 1; // Recipient User ID (UUID) - stable identifier
  int64 amount = 2;
  string currency = 3;
  string narration = 4;
  string idempotency_key = 5;
  string verification_token = 6;
  string transaction_id = 7;
}

message InitiatePhoneTransferRequest {
  string to_phone = 1;
  int64 amount = 2;
  string currency = 3;
  string narration = 4;
  string idempotency_key = 5;
  string verification_token = 6;
  string transaction_id = 7;
}

message InitiateTransferResponse {
  bool success = 1;
  string error_code = 2;
  string error_message = 3;
  TransferDetail transfer = 4;
}

message TransferDetail {
  string id = 1;
  string user_id = 2;
  string type = 3;
  string status = 4;
  int64 amount = 5;
  string currency = 6;
  int64 fee = 7;
  string source_account_id = 8;
  string destination_account = 9;
  string destination_bank_code = 10;
  string destination_bank_name = 11;
  string destination_name = 12;
  string destination_country = 13;
  string reference = 14;
  string provider_ref = 15;
  string provider = 16;
  string narration = 17;
  string failure_reason = 18;
  string created_at = 19;
  string completed_at = 20;
}

message GetTransferStatusRequest {
  string reference = 1;
}

message GetTransferStatusResponse {
  bool success = 1;
  string error_code = 2;
  string error_message = 3;
  TransferDetail transfer = 4;
}

message GetUserTransfersRequest {
  int32 limit = 1;
  int32 offset = 2;
  string transfer_type = 3;
  string status = 4;
}

message GetUserTransfersResponse {
  bool success = 1;
  string error_code = 2;
  string error_message = 3;
  repeated TransferDetail transfers = 4;
  int32 total = 5;
}

message GetTransferFeeRequest {
  string transfer_type = 1;
  int64 amount = 2;
  string currency = 3;
  string destination_country = 4;
}

message GetTransferFeeResponse {
  bool success = 1;
  string error_code = 2;
  string error_message = 3;
  int64 fee = 4;
  string currency = 5;
}

message GetDailyUsageRequest {}

message GetDailyUsageResponse {
  bool success = 1;
  string error_code = 2;
  string error_message = 3;
  int64 total_transferred = 4;
  int32 transfer_count = 5;
  int64 daily_limit = 6;
  int64 remaining_limit = 7;
}

message GetExchangeRateRequest {
  string source_currency = 1;
  string destination_currency = 2;
  int64 amount = 3;
}

message GetExchangeRateResponse {
  bool success = 1;
  string error_code = 2;
  string error_message = 3;
  string source_currency = 4;
  string destination_currency = 5;
  double rate = 6;
  int64 fee = 7;
  int64 destination_amount = 8;
}

message HandleTransferWebhookRequest {
  string provider = 1;
  bytes payload = 2;
  string signature = 3;
}

message HandleTransferWebhookResponse {
  bool success = 1;
  string message = 2;
}

// === PLATFORM FEE MESSAGES ===

message PayPlatformFeeRequest {
  string user_account_id = 1;           // User account to debit
  string user_id = 2;                   // Account owner
  int64 amount = 3;                     // Amount in minor units (kobo/cents)
  string currency = 4;                  // Currency code
  string category = 5;                  // e.g., "service_fee", "invoice_unlock"
  string description = 6;               // Human-readable description
  string reference = 7;                 // Unique reference
  string idempotency_key = 8;           // Idempotency key
  string verification_token = 9;        // PIN verification token
  string transaction_id = 10;           // Transaction ID for PIN verification
  string wallet_code = 11;              // Platform wallet code (default: "REVENUE")
}

message PayPlatformFeeResponse {
  bool success = 1;
  string error_code = 2;
  string error_message = 3;
  string debit_transaction_id = 4;
  string platform_transaction_id = 5;
  int64 user_new_balance = 6;
  string reference = 7;
}

message RefundFromPlatformWalletRequest {
  string user_account_id = 1;           // User account to credit
  string user_id = 2;                   // Account owner
  int64 amount = 3;                     // Amount in minor units
  string currency = 4;
  string category = 5;                  // e.g., "refund"
  string description = 6;
  string reference = 7;
  string idempotency_key = 8;
  string wallet_code = 9;               // Platform wallet code (default: "REVENUE")
}

message RefundFromPlatformWalletResponse {
  bool success = 1;
  string error_code = 2;
  string error_message = 3;
  string credit_transaction_id = 4;
  int64 user_new_balance = 5;
  string reference = 6;
}

// ===== QR PAYMENT TOKEN =====

message GenerateQRTokenRequest {
  int64 amount = 1;          // 0 = static QR (no amount), >0 = dynamic QR with amount in minor units
  string currency = 2;
  string description = 3;
  int32 expiry_minutes = 4;  // 0 = no expiry (static), >0 = minutes until expiry
}

message GenerateQRTokenResponse {
  bool success = 1;
  string error_code = 2;
  string error_message = 3;
  string qr_token = 4;       // HMAC-signed token
  string qr_data = 5;        // JSON string for QR encoding
  string expires_at = 6;     // ISO timestamp, empty for static
}

message ValidateQRTokenRequest {
  string qr_token = 1;
}

message ValidateQRTokenResponse {
  bool success = 1;
  string error_code = 2;
  string error_message = 3;
  string recipient_user_id = 4;
  string recipient_username = 5;
  string recipient_name = 6;
  string recipient_account_id = 7;
  int64 amount = 8;           // 0 = static (scanner enters amount)
  string currency = 9;
  bool is_expired = 10;
}

// ===== BATCH TRANSFER HISTORY =====

message GetBatchTransfersRequest {
  int32 page = 1;
  int32 page_size = 2;
}

message BatchTransferSummary {
  string batch_id = 1;
  int32 total_recipients = 2;
  int32 successful = 3;
  int32 failed = 4;
  double total_amount = 5;
  double total_fees = 6;
  string status = 7;          // "completed", "partial", "failed"
  string created_at = 8;
  string currency = 9;
}

message GetBatchTransfersResponse {
  repeated BatchTransferSummary batches = 1;
  int32 total = 2;
  int32 page = 3;
  int32 page_size = 4;
}

message GetBatchTransferDetailRequest {
  string batch_id = 1;
}

message GetBatchTransferDetailResponse {
  BatchTransferSummary summary = 1;
  repeated BatchTransferResultItem items = 2;
  string source_account_number = 3;
  string source_account_name = 4;
}
