syntax = "proto3";

package pb;

import "google/protobuf/timestamp.proto";
import "google/api/annotations.proto";
import "protoc-gen-openapiv2/options/annotations.proto";
import "account.proto"; // Needed for AccountDetails

option go_package = "lazervaultGo/pb";

// OpenAPI v2 documentation options for the Deposit Service
option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = {
  info: {
    title: "LazerVault Deposit Service (Async)"; // Updated title
    version: "1.0";
    contact: {
      name: "LazerVault Support";
      url: "https://github.com/LazerVault";
      email: "support@lazervault.example";
    };
  };
  security_definitions: {
    security: {
      key: "bearer"
      value: {
        type: TYPE_API_KEY
        in: IN_HEADER
        name: "Authorization"
        description: "Authentication token, prefixed by Bearer: Bearer <token>"
      }
    }
  }
  security: {
    security_requirement: {
      key: "bearer"
    }
  }
};

// Represents the status of a deposit transaction
enum DepositStatus {
  DEPOSIT_STATUS_UNSPECIFIED = 0;
  DEPOSIT_STATUS_PENDING = 1;
  DEPOSIT_STATUS_PROCESSING = 2;
  DEPOSIT_STATUS_COMPLETED = 3;
  DEPOSIT_STATUS_FAILED = 4; // Note: This represents final failure *after* processing attempt
}

// Request to initiate a deposit
message InitiateDepositRequest {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      required: ["target_account_id", "amount", "currency", "source_bank_name"]
    }
  };

  string target_account_id = 1 [json_name = "target_account_id"]; // Account UUID to deposit into
  // Amount represented in the smallest currency unit (e.g., cents for GBP/USD)
  uint64 amount = 2;
  string currency = 3;          // Currency code (e.g., GBP) - must match account
  string source_bank_name = 4 [json_name = "source_bank_name"]; // Name of the originating bank
  string country_code = 5 [json_name = "country_code"]; // "NG", "GH", "KE", "ZA", "US", "GB"
  string locale = 6;            // BCP 47 locale (e.g., "en-GH", "en-KE")
}

// Response after initiating a deposit (acknowledgement)
message InitiateDepositResponse {
  string deposit_id = 1 [json_name = "deposit_id"]; // The unique ID of the initiated deposit record
  DepositStatus status = 2;                       // Initial status (should be PENDING)
  string message = 3;                             // Confirmation message (e.g., "Deposit initiated, processing asynchronously.")
  bool requires_authorization = 4 [json_name = "requires_authorization"]; // True for Flutterwave Standard
  string payment_url = 5 [json_name = "payment_url"];           // Flutterwave hosted checkout URL
  string provider = 6;              // "mono", "flutterwave"
  string country_code = 7 [json_name = "country_code"];
}

// Request to get details of a specific deposit transaction
message GetDepositDetailsRequest {
  string deposit_id = 1 [json_name = "deposit_id"]; // The UUID of the deposit to retrieve
}

// Response containing details of a specific deposit transaction
message GetDepositDetailsResponse {
  string deposit_id = 1 [json_name = "deposit_id"];
  string target_account_id = 2 [json_name = "target_account_id"];
  // Amount represented in the smallest currency unit (e.g., cents)
  uint64 amount = 3;
  string currency = 4;
  string source_bank_name = 5 [json_name = "source_bank_name"];
  DepositStatus status = 6;
  google.protobuf.Timestamp created_at = 7 [json_name = "created_at"];
  google.protobuf.Timestamp processing_at = 8 [json_name = "processing_at"]; // Null if not yet processed
  google.protobuf.Timestamp completed_at = 9 [json_name = "completed_at"];  // Null if not completed
  google.protobuf.Timestamp failed_at = 10 [json_name = "failed_at"];      // Null if not failed
  string failure_reason = 11 [json_name = "failure_reason"];      // Empty if not failed
  string external_transaction_id = 12 [json_name = "external_transaction_id"]; // Optional ID from provider

  // Updated account details are included only if the deposit status is COMPLETED.
  AccountDetails updated_account = 13 [json_name = "updated_account"];
}

// Request to simulate a test deposit (sandbox only)
message SimulateTestDepositRequest {
  string destination_account_id = 1 [json_name = "destination_account_id"];
  uint64 amount = 2;
  string currency = 3;
  string country_code = 4 [json_name = "country_code"];
}

// Request to get available deposit methods for a country
message GetDepositMethodsRequest {
  string country_code = 1 [json_name = "country_code"];
  string currency = 2;
}

// Response containing available deposit methods
message GetDepositMethodsResponse {
  repeated DepositMethod methods = 1;
  string country_code = 2 [json_name = "country_code"];
  string currency = 3;
  string provider = 4;
}

// A single deposit method available for a country
message DepositMethod {
  string id = 1;               // "mobile_money", "card", "bank_transfer", "mpesa"
  string name = 2;             // "Mobile Money"
  string description = 3;     // "Pay with MTN, Vodafone or Tigo"
  string icon = 4;             // Icon name for Flutter
  string fee_description = 5 [json_name = "fee_description"]; // "1.5%"
  string processing_time = 6 [json_name = "processing_time"]; // "Instant"
  bool available = 7;
}

// Service for handling deposits (asynchronous)
service DepositService {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_tag) = {
    description: "Handles asynchronous fund deposits into user accounts."
  };

  // Initiates a deposit into a specified account.
  // The deposit will be processed asynchronously.
  // Amount should be provided in the smallest currency unit (e.g., cents).
  rpc InitiateDeposit (InitiateDepositRequest) returns (InitiateDepositResponse) {
    option (google.api.http) = {
      post: "/v1/deposits"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Initiate Deposit (Async)"
      description: "Initiates the process of depositing funds. The actual balance update occurs asynchronously. Amount should be provided in the smallest currency unit (e.g., cents)."
      tags: ["Deposits"]
      security: {
         security_requirement: { key: "bearer" }
      }
    };
  }

  // Retrieves the details and status of a specific deposit transaction.
  rpc GetDepositDetails (GetDepositDetailsRequest) returns (GetDepositDetailsResponse) {
    option (google.api.http) = {
      get: "/v1/deposits/{deposit_id}" // Map GET request with deposit_id in path
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get Deposit Details"
      description: "Retrieves the current status and details of a specific deposit transaction by its ID."
      tags: ["Deposits"]
      security: {
         security_requirement: { key: "bearer" }
      }
    };
  }

  // Simulate a test deposit (sandbox only)
  rpc SimulateTestDeposit (SimulateTestDepositRequest) returns (InitiateDepositResponse) {
    option (google.api.http) = {
      post: "/v1/deposits/simulate"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Simulate Test Deposit"
      description: "Simulates a deposit for sandbox testing. Creates record and immediately credits account."
      tags: ["Deposits"]
      security: {
         security_requirement: { key: "bearer" }
      }
    };
  }

  // Get available deposit methods for a country
  rpc GetDepositMethods (GetDepositMethodsRequest) returns (GetDepositMethodsResponse) {
    option (google.api.http) = {
      get: "/v1/deposits/methods"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get Deposit Methods"
      description: "Returns available deposit methods for a given country and currency."
      tags: ["Deposits"]
      security: {
         security_requirement: { key: "bearer" }
      }
    };
  }
} 